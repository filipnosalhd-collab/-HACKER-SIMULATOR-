<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hacker Simulator</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Share Tech Mono", "Courier New", monospace;
        background: #000;
        color: #00ff00;
        overflow-x: hidden;
        min-height: 100vh;
        position: relative;
      }

      /* Animated background */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            ellipse at 20% 80%,
            rgba(0, 255, 100, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse at 80% 20%,
            rgba(0, 200, 255, 0.1) 0%,
            transparent 50%
          ),
          radial-gradient(
            ellipse at 50% 50%,
            rgba(255, 0, 100, 0.05) 0%,
            transparent 70%
          ),
          linear-gradient(180deg, #0a0a0f 0%, #0f1a0f 50%, #0a0f1a 100%);
        z-index: -2;
        animation: bgPulse 10s ease-in-out infinite;
      }

      @keyframes bgPulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
      }

      /* Matrix rain effect */
      .matrix-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.1;
        pointer-events: none;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 255, 0, 0.03) 2px,
          rgba(0, 255, 0, 0.03) 4px
        );
        animation: scanlines 0.1s linear infinite;
      }

      @keyframes scanlines {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 0 4px;
        }
      }

      /* Glowing grid */
      body::after {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: linear-gradient(
            rgba(0, 255, 0, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 255, 0, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: -1;
        animation: gridMove 20s linear infinite;
      }

      @keyframes gridMove {
        0% {
          transform: perspective(500px) rotateX(60deg) translateY(0);
        }
        100% {
          transform: perspective(500px) rotateX(60deg) translateY(50px);
        }
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
      }

      .header {
        text-align: center;
        padding: 30px;
        background: linear-gradient(
          135deg,
          rgba(0, 20, 0, 0.9) 0%,
          rgba(0, 40, 20, 0.9) 100%
        );
        border: 2px solid transparent;
        border-image: linear-gradient(
            135deg,
            #00ff00,
            #00ffff,
            #ff00ff,
            #00ff00
          )
          1;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        clip-path: polygon(
          0 0,
          100% 0,
          100% calc(100% - 15px),
          calc(100% - 15px) 100%,
          0 100%
        );
      }

      .header::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent 40%,
          rgba(0, 255, 0, 0.1) 50%,
          transparent 60%
        );
        animation: headerShine 3s linear infinite;
      }

      @keyframes headerShine {
        0% {
          transform: translateX(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      .header h1 {
        font-family: "Orbitron", sans-serif;
        font-size: clamp(28px, 6vw, 56px);
        font-weight: 900;
        background: linear-gradient(
          135deg,
          #00ff00 0%,
          #00ffff 25%,
          #ff00ff 50%,
          #ffff00 75%,
          #00ff00 100%
        );
        background-size: 400% 400%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradientText 5s ease infinite;
        text-shadow: none;
        filter: drop-shadow(0 0 10px rgba(0, 255, 0, 0.5))
          drop-shadow(0 0 20px rgba(0, 255, 255, 0.3));
        margin-bottom: 10px;
        letter-spacing: 3px;
      }

      @keyframes gradientText {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .header p {
        font-size: clamp(14px, 2vw, 18px);
        color: #00ffff;
        text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        letter-spacing: 2px;
      }

      .mission-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .info-box {
        background: linear-gradient(
          135deg,
          rgba(0, 30, 0, 0.9) 0%,
          rgba(0, 50, 30, 0.9) 100%
        );
        border: 2px solid #00ff00;
        padding: 15px;
        text-align: center;
        position: relative;
        overflow: hidden;
        clip-path: polygon(
          10px 0,
          100% 0,
          100% calc(100% - 10px),
          calc(100% - 10px) 100%,
          0 100%,
          0 10px
        );
        transition: all 0.3s ease;
      }

      .info-box::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          135deg,
          transparent 0%,
          rgba(0, 255, 0, 0.1) 50%,
          transparent 100%
        );
        opacity: 0;
        transition: opacity 0.3s;
      }

      .info-box:hover::before {
        opacity: 1;
      }

      .info-box:hover {
        border-color: #00ffff;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.5),
          inset 0 0 20px rgba(0, 255, 0, 0.1);
        transform: translateY(-3px);
      }

      .info-box h3 {
        font-family: "Orbitron", sans-serif;
        font-size: 11px;
        color: #00ffff;
        margin-bottom: 8px;
        letter-spacing: 2px;
        text-transform: uppercase;
      }

      .info-box p {
        font-size: clamp(20px, 3vw, 28px);
        font-weight: bold;
        color: #00ff00;
        text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
      }

      .game-area {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
      }

      @media (min-width: 1024px) {
        .game-area {
          grid-template-columns: 1fr 380px;
        }
      }

      .laptop-container {
        background: linear-gradient(
          135deg,
          rgba(0, 10, 0, 0.95) 0%,
          rgba(0, 30, 20, 0.95) 100%
        );
        border: 3px solid #00ff00;
        padding: 25px;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        position: relative;
        overflow: hidden;
        clip-path: polygon(
          0 0,
          calc(100% - 20px) 0,
          100% 20px,
          100% 100%,
          20px 100%,
          0 calc(100% - 20px)
        );
      }

      .laptop-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          #00ff00,
          #00ffff,
          #00ff00,
          transparent
        );
        animation: borderGlow 2s linear infinite;
      }

      .laptop-container::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
          90deg,
          transparent,
          #ff00ff,
          #00ffff,
          #ff00ff,
          transparent
        );
        animation: borderGlow 2s linear infinite reverse;
      }

      @keyframes borderGlow {
        0% {
          opacity: 0.5;
          filter: blur(0px);
        }
        50% {
          opacity: 1;
          filter: blur(2px);
        }
        100% {
          opacity: 0.5;
          filter: blur(0px);
        }
      }

      .laptop-3d {
        width: 100%;
        max-width: 600px;
        perspective: 1000px;
        margin-bottom: 20px;
      }

      .laptop-inner {
        width: 100%;
        position: relative;
        transform-style: preserve-3d;
        animation: floatLaptop 6s ease-in-out infinite;
      }

      @keyframes floatLaptop {
        0%,
        100% {
          transform: translateY(0) rotateX(2deg);
        }
        50% {
          transform: translateY(-5px) rotateX(-2deg);
        }
      }

      .laptop-screen {
        width: 100%;
        min-height: 280px;
        background: linear-gradient(180deg, #0a0a0a 0%, #0f0f0f 100%);
        border: 4px solid #1a1a1a;
        border-radius: 10px 10px 0 0;
        position: relative;
        box-shadow: inset 0 0 50px rgba(0, 255, 0, 0.05),
          0 0 30px rgba(0, 255, 0, 0.2);
        display: flex;
        flex-direction: column;
        padding: 15px;
        overflow: hidden;
      }

      .laptop-screen::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.1) 2px,
          rgba(0, 0, 0, 0.1) 4px
        );
        pointer-events: none;
        z-index: 10;
      }

      .laptop-base {
        width: 110%;
        height: 25px;
        background: linear-gradient(
          180deg,
          #2a2a2a 0%,
          #1a1a1a 50%,
          #0a0a0a 100%
        );
        border: 2px solid #333;
        margin-left: -5%;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
        position: relative;
      }

      .laptop-base::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 8px;
        background: linear-gradient(90deg, #333, #444, #333);
        border-radius: 4px;
      }

      .screen-content {
        flex: 1;
        overflow-y: auto;
        font-size: clamp(11px, 1.8vw, 14px);
        line-height: 1.5;
        padding-right: 10px;
      }

      .screen-content::-webkit-scrollbar {
        width: 6px;
      }

      .screen-content::-webkit-scrollbar-track {
        background: #0a0a0a;
        border-radius: 3px;
      }

      .screen-content::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #00ff00, #00aa00);
        border-radius: 3px;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      }

      .code-line {
        margin: 3px 0;
        padding: 3px 8px;
        animation: typeLine 0.3s ease-out;
        border-left: 2px solid transparent;
        transition: all 0.2s;
      }

      .code-line:hover {
        background: rgba(0, 255, 0, 0.05);
        border-left-color: #00ff00;
      }

      @keyframes typeLine {
        from {
          opacity: 0;
          transform: translateX(-20px);
          filter: blur(5px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
          filter: blur(0);
        }
      }

      .command-prompt {
        color: #00ffff;
        font-weight: bold;
        text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
      }

      .code-highlight {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 0, 0.2),
          rgba(255, 200, 0, 0.1)
        );
        color: #ffff00;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 3px;
        text-shadow: 0 0 5px rgba(255, 255, 0, 0.5);
      }

      .keys-display {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
        padding: 25px;
        background: linear-gradient(
          135deg,
          rgba(0, 50, 0, 0.3) 0%,
          rgba(0, 100, 50, 0.2) 100%
        );
        border: 2px solid rgba(0, 255, 0, 0.5);
        border-radius: 15px;
        box-shadow: 0 0 30px rgba(0, 255, 0, 0.2),
          inset 0 0 30px rgba(0, 255, 0, 0.05);
      }

      .key {
        background: linear-gradient(
          135deg,
          #00ff00 0%,
          #00cc00 50%,
          #00aa00 100%
        );
        color: #000;
        padding: 18px 25px;
        border-radius: 10px;
        font-size: clamp(20px, 3vw, 28px);
        font-weight: bold;
        font-family: "Orbitron", sans-serif;
        box-shadow: 0 6px 20px rgba(0, 255, 0, 0.6),
          0 0 30px rgba(0, 255, 0, 0.4), inset 0 2px 0 rgba(255, 255, 255, 0.3);
        animation: keyFloat 2s ease-in-out infinite;
        min-width: 65px;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
      }

      .key::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          45deg,
          transparent 40%,
          rgba(255, 255, 255, 0.3) 50%,
          transparent 60%
        );
        animation: keyShine 2s linear infinite;
      }

      @keyframes keyShine {
        0% {
          transform: translateX(-100%) rotate(45deg);
        }
        100% {
          transform: translateX(100%) rotate(45deg);
        }
      }

      @keyframes keyFloat {
        0%,
        100% {
          transform: translateY(0) scale(1);
        }
        50% {
          transform: translateY(-5px) scale(1.02);
        }
      }

      .input-area {
        width: 100%;
        margin-top: 20px;
      }

      .input-display {
        background: linear-gradient(
          135deg,
          rgba(0, 20, 0, 0.9) 0%,
          rgba(0, 40, 20, 0.9) 100%
        );
        border: 3px solid #00ff00;
        padding: 18px;
        margin-bottom: 15px;
        min-height: 60px;
        font-size: clamp(18px, 2.5vw, 24px);
        text-align: center;
        border-radius: 10px;
        word-break: break-all;
        text-transform: none !important;
        font-variant: normal !important;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3),
          inset 0 0 20px rgba(0, 255, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .input-display::after {
        content: "|";
        animation: blink 1s infinite;
        color: #00ff00;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      .keyboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
        gap: 8px;
        margin-bottom: 15px;
      }

      .key-button {
        background: linear-gradient(180deg, #1a2a1a 0%, #0a1a0a 100%);
        border: 2px solid #00aa00;
        color: #00ff00;
        padding: 15px 8px;
        font-size: clamp(14px, 2vw, 18px);
        font-family: "Share Tech Mono", monospace;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.15s ease;
        font-weight: bold;
        position: relative;
        overflow: hidden;
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
      }

      .key-button::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 255, 0, 0.2),
          transparent
        );
        transition: left 0.3s;
      }

      .key-button:hover::before {
        left: 100%;
      }

      .key-button:hover {
        background: linear-gradient(180deg, #2a4a2a 0%, #1a3a1a 100%);
        border-color: #00ff00;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5), 0 0 40px rgba(0, 255, 0, 0.2);
        transform: translateY(-2px);
      }

      .key-button:active {
        transform: translateY(1px);
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
      }

      .key-button:hover {
        background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 255, 0, 0.5);
      }

      .key-button:active {
        transform: translateY(0);
      }

      .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .btn {
        flex: 1;
        min-width: 120px;
        padding: 16px 20px;
        font-size: clamp(14px, 2vw, 16px);
        font-family: "Orbitron", sans-serif;
        font-weight: bold;
        border: 2px solid #00ff00;
        background: linear-gradient(180deg, #1a2a1a 0%, #0a1a0a 100%);
        color: #00ff00;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 255, 0, 0.3),
          transparent
        );
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        background: linear-gradient(180deg, #00ff00 0%, #00cc00 100%);
        color: #000;
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 255, 0, 0.5),
          0 0 50px rgba(0, 255, 0, 0.3);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .target-info {
        background: linear-gradient(
          135deg,
          rgba(30, 0, 0, 0.9) 0%,
          rgba(50, 10, 10, 0.9) 100%
        );
        border: 3px solid #ff0000;
        padding: 20px;
        position: relative;
        overflow: hidden;
        clip-path: polygon(
          0 0,
          100% 0,
          100% calc(100% - 15px),
          calc(100% - 15px) 100%,
          0 100%
        );
      }

      .target-info::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          transparent,
          #ff0000,
          #ff6600,
          #ff0000,
          transparent
        );
        animation: targetGlow 2s linear infinite;
      }

      @keyframes targetGlow {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      .target-info h2 {
        font-family: "Orbitron", sans-serif;
        color: #ff0000;
        margin-bottom: 15px;
        font-size: clamp(18px, 3vw, 24px);
        text-shadow: 0 0 15px rgba(255, 0, 0, 0.8);
        letter-spacing: 2px;
      }

      .target-detail {
        margin: 12px 0;
        padding: 12px;
        background: linear-gradient(
          90deg,
          rgba(255, 0, 0, 0.1) 0%,
          transparent 100%
        );
        border-left: 4px solid #ff0000;
        transition: all 0.3s;
      }

      .target-detail:hover {
        background: linear-gradient(
          90deg,
          rgba(255, 0, 0, 0.2) 0%,
          transparent 100%
        );
        border-left-color: #ff6600;
        transform: translateX(5px);
      }

      .target-detail strong {
        color: #ff6600;
        font-family: "Orbitron", sans-serif;
        font-size: 11px;
        letter-spacing: 1px;
      }

      .stats-panel {
        background: linear-gradient(
          135deg,
          rgba(0, 20, 30, 0.9) 0%,
          rgba(0, 40, 50, 0.9) 100%
        );
        border: 3px solid #00ffff;
        padding: 20px;
        position: relative;
        overflow: hidden;
        clip-path: polygon(15px 0, 100% 0, 100% 100%, 0 100%, 0 15px);
      }

      .stats-panel::before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          transparent,
          #00ffff,
          #00ff00,
          #00ffff,
          transparent
        );
        animation: statsGlow 3s linear infinite;
      }

      @keyframes statsGlow {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }

      .stats-panel h2 {
        font-family: "Orbitron", sans-serif;
        color: #00ffff;
        margin-bottom: 15px;
        font-size: clamp(18px, 3vw, 24px);
        text-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
        letter-spacing: 2px;
      }

      .stat-item {
        margin: 12px 0;
        padding: 12px;
        background: linear-gradient(
          90deg,
          rgba(0, 255, 255, 0.1) 0%,
          transparent 100%
        );
        border-left: 4px solid #00ffff;
        transition: all 0.3s;
      }

      .stat-item:hover {
        background: linear-gradient(
          90deg,
          rgba(0, 255, 255, 0.2) 0%,
          transparent 100%
        );
        border-left-color: #00ff00;
        transform: translateX(5px);
      }

      .stat-item strong {
        color: #00ffff;
        font-family: "Orbitron", sans-serif;
        font-size: 11px;
      }

      .progress-bar {
        width: 100%;
        height: 25px;
        background: linear-gradient(180deg, #0a0a0a 0%, #1a1a1a 100%);
        border: 2px solid #00ff00;
        margin-top: 15px;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .progress-bar::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
          90deg,
          transparent,
          transparent 10px,
          rgba(0, 0, 0, 0.2) 10px,
          rgba(0, 0, 0, 0.2) 20px
        );
        z-index: 2;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          180deg,
          #00ff00 0%,
          #00aa00 50%,
          #00ff00 100%
        );
        transition: width 0.5s ease-out;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.8),
          inset 0 -3px 10px rgba(0, 0, 0, 0.3);
        position: relative;
        animation: progressPulse 2s ease-in-out infinite;
      }

      @keyframes progressPulse {
        0%,
        100% {
          filter: brightness(1);
        }
        50% {
          filter: brightness(1.2);
        }
      }

      .timer {
        font-family: "Orbitron", sans-serif;
        font-size: clamp(28px, 5vw, 42px);
        font-weight: bold;
        text-align: center;
        padding: 20px;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.9) 0%,
          rgba(20, 20, 0, 0.9) 100%
        );
        border: 3px solid #ffff00;
        margin-top: 15px;
        color: #ffff00;
        text-shadow: 0 0 10px #ffff00, 0 0 20px rgba(255, 255, 0, 0.5);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
        letter-spacing: 3px;
      }

      .timer::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          45deg,
          transparent 40%,
          rgba(255, 255, 0, 0.1) 50%,
          transparent 60%
        );
        animation: timerShine 2s linear infinite;
      }

      @keyframes timerShine {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(
          135deg,
          rgba(0, 10, 0, 0.98) 0%,
          rgba(0, 30, 20, 0.98) 100%
        );
        border: 4px solid #00ff00;
        padding: 50px 70px;
        font-family: "Orbitron", sans-serif;
        font-size: clamp(24px, 4vw, 40px);
        font-weight: bold;
        z-index: 1000;
        text-align: center;
        box-shadow: 0 0 50px rgba(0, 255, 0, 0.6),
          0 0 100px rgba(0, 255, 0, 0.3), inset 0 0 50px rgba(0, 255, 0, 0.1);
        animation: messagePopIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        max-width: 90%;
        clip-path: polygon(
          20px 0,
          100% 0,
          100% calc(100% - 20px),
          calc(100% - 20px) 100%,
          0 100%,
          0 20px
        );
        letter-spacing: 2px;
      }

      @keyframes messagePopIn {
        from {
          transform: translate(-50%, -50%) scale(0) rotate(-10deg);
          opacity: 0;
        }
        to {
          transform: translate(-50%, -50%) scale(1) rotate(0deg);
          opacity: 1;
        }
      }

      .message.error {
        border-color: #ff0000;
        color: #ff0000;
        background: linear-gradient(
          135deg,
          rgba(30, 0, 0, 0.98) 0%,
          rgba(50, 10, 10, 0.98) 100%
        );
        box-shadow: 0 0 50px rgba(255, 0, 0, 0.6),
          0 0 100px rgba(255, 0, 0, 0.3), inset 0 0 50px rgba(255, 0, 0, 0.1);
        text-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
      }

      .message.success {
        border-color: #00ff00;
        color: #00ff00;
        text-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
      }

      .phase-indicator {
        text-align: center;
        font-family: "Orbitron", sans-serif;
        font-size: clamp(16px, 2.5vw, 22px);
        padding: 18px 25px;
        background: linear-gradient(
          135deg,
          rgba(0, 30, 0, 0.9) 0%,
          rgba(0, 50, 30, 0.9) 100%
        );
        border: 3px solid #00ff00;
        margin-bottom: 20px;
        font-weight: bold;
        position: relative;
        overflow: hidden;
        clip-path: polygon(
          15px 0,
          calc(100% - 15px) 0,
          100% 15px,
          100% 100%,
          0 100%,
          0 15px
        );
        letter-spacing: 1px;
        text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      }

      .phase-indicator::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 255, 0, 0.2),
          transparent
        );
        animation: phaseShine 3s linear infinite;
      }

      @keyframes phaseShine {
        0% {
          left: -50%;
        }
        100% {
          left: 150%;
        }
      }

      /* ============ RESPONSYWNOŚĆ - WSZYSTKIE URZĄDZENIA ============ */

      /* Duże ekrany (desktop) */
      @media (min-width: 1200px) {
        .container {
          padding: 25px;
        }

        .header h1 {
          font-size: 48px;
        }
      }

      /* Tablety i małe laptopy */
      @media (max-width: 1024px) {
        .game-area {
          grid-template-columns: 1fr !important;
        }

        .sidebar {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
        }

        .laptop-3d {
          max-width: 100%;
        }
      }

      /* Tablety */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header {
          padding: 15px;
          padding-top: 50px;
        }

        .header h1 {
          font-size: 24px;
          letter-spacing: 1px;
        }

        .header p {
          font-size: 12px;
        }

        .settings-btn {
          width: 40px;
          height: 40px;
          font-size: 18px;
          top: 10px;
          right: 10px;
        }

        .mission-info {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }

        .info-box {
          padding: 10px;
        }

        .info-box h3 {
          font-size: 9px;
        }

        .info-box p {
          font-size: 16px;
        }

        .sidebar {
          grid-template-columns: 1fr;
        }

        .laptop-container {
          padding: 15px;
          min-height: 400px;
        }

        .laptop-screen {
          min-height: 200px;
        }

        .screen-content {
          font-size: 11px;
        }

        .keys-display {
          padding: 15px;
          gap: 10px;
        }

        .key {
          padding: 12px 15px;
          font-size: 18px;
          min-width: 50px;
        }

        .keyboard {
          grid-template-columns: repeat(auto-fit, minmax(36px, 1fr));
          gap: 4px;
        }

        .key-button {
          padding: 12px 4px;
          font-size: 12px;
        }

        .input-display {
          font-size: 16px;
          padding: 12px;
          min-height: 50px;
        }

        .btn {
          padding: 12px 15px;
          font-size: 12px;
        }

        .action-buttons {
          gap: 8px;
        }

        .phase-indicator {
          font-size: 14px;
          padding: 12px;
        }

        .timer {
          font-size: 24px;
          padding: 12px;
        }

        .target-info,
        .stats-panel {
          padding: 15px;
        }

        .target-info h2,
        .stats-panel h2 {
          font-size: 16px;
          margin-bottom: 10px;
        }

        .target-detail,
        .stat-item {
          padding: 8px;
          font-size: 12px;
        }

        .progress-bar {
          height: 20px;
        }

        .message {
          padding: 30px 40px;
          font-size: 20px;
        }

        .catch-game {
          height: 280px;
        }

        .catch-target {
          width: 60px;
          height: 60px;
          font-size: 40px;
        }

        .catch-emoji {
          font-size: 45px;
        }

        .catch-result {
          font-size: 28px;
          letter-spacing: 10px;
        }

        .catch-info {
          font-size: 14px;
        }
      }

      /* Telefony */
      @media (max-width: 480px) {
        .container {
          padding: 5px;
        }

        .header {
          padding: 10px;
          padding-top: 45px;
          margin-bottom: 10px;
        }

        .header h1 {
          font-size: 18px;
        }

        .header p {
          font-size: 10px;
        }

        .settings-btn {
          width: 35px;
          height: 35px;
          font-size: 16px;
          top: 8px;
          right: 8px;
        }

        .mission-info {
          grid-template-columns: repeat(2, 1fr);
          gap: 5px;
          margin-bottom: 10px;
        }

        .info-box {
          padding: 8px 5px;
          clip-path: none;
        }

        .info-box h3 {
          font-size: 8px;
          margin-bottom: 3px;
        }

        .info-box p {
          font-size: 14px;
        }

        .game-area {
          gap: 10px;
        }

        .laptop-container {
          padding: 10px;
          min-height: 350px;
          clip-path: none;
        }

        .laptop-3d {
          margin-bottom: 10px;
        }

        .laptop-screen {
          min-height: 180px;
          padding: 10px;
          border-radius: 5px 5px 0 0;
        }

        .laptop-base {
          height: 20px;
          border-radius: 0 0 5px 5px;
        }

        .screen-content {
          font-size: 10px;
          line-height: 1.4;
        }

        .keys-display {
          padding: 10px;
          gap: 8px;
          margin: 10px 0;
          border-radius: 10px;
        }

        .key {
          padding: 10px 12px;
          font-size: 16px;
          min-width: 45px;
          border-radius: 6px;
        }

        .input-area {
          margin-top: 10px;
        }

        .input-display {
          font-size: 14px;
          padding: 10px;
          min-height: 45px;
          margin-bottom: 8px;
        }

        .keyboard {
          grid-template-columns: repeat(10, 1fr);
          gap: 3px;
        }

        .key-button {
          padding: 10px 2px;
          font-size: 11px;
          border-radius: 4px;
          border-width: 1px;
        }

        .action-buttons {
          gap: 5px;
          margin-top: 8px;
        }

        .btn {
          padding: 10px 8px;
          font-size: 11px;
          min-width: 80px;
          border-radius: 6px;
        }

        .phase-indicator {
          font-size: 12px;
          padding: 10px;
          margin-bottom: 10px;
          clip-path: none;
        }

        .timer {
          font-size: 20px;
          padding: 10px;
          margin-top: 10px;
          border-radius: 6px;
        }

        .sidebar {
          gap: 10px;
        }

        .target-info,
        .stats-panel {
          padding: 12px;
          clip-path: none;
        }

        .target-info h2,
        .stats-panel h2 {
          font-size: 14px;
          margin-bottom: 8px;
        }

        .target-detail,
        .stat-item {
          padding: 6px;
          margin: 6px 0;
          font-size: 11px;
        }

        .progress-bar {
          height: 15px;
          margin-top: 8px;
        }

        .message {
          padding: 25px 30px;
          font-size: 16px;
          border-width: 3px;
          border-radius: 15px;
        }

        .catch-game {
          height: 250px;
          margin: 10px 0;
          border-radius: 10px;
        }

        .catch-target {
          width: 55px;
          height: 55px;
          font-size: 35px;
          border-width: 3px;
        }

        .catch-emoji {
          font-size: 40px;
        }

        .catch-result {
          font-size: 24px;
          letter-spacing: 8px;
          top: 10px;
        }

        .catch-info {
          font-size: 12px;
          margin: 8px 0;
        }

        .catch-errors {
          font-size: 12px;
        }

        .forgot-btn {
          padding: 10px 20px;
          font-size: 12px;
        }

        .emoji-btn {
          font-size: 24px !important;
          padding: 10px !important;
        }

        /* Warning overlay na telefonie */
        .warning-overlay h1 {
          font-size: 40px;
        }

        .warning-overlay p {
          font-size: 12px;
          margin-bottom: 20px;
          padding: 0 10px;
        }

        .quality-selector {
          flex-direction: column;
          gap: 10px;
          margin: 20px 0;
        }

        .quality-btn {
          padding: 12px 25px;
          font-size: 12px;
        }

        .quality-label {
          font-size: 14px;
        }

        .warning-overlay .start-btn {
          padding: 18px 50px;
          font-size: 16px;
        }

        /* Settings modal na telefonie */
        .settings-content {
          padding: 25px;
          width: 95%;
        }

        .settings-content h2 {
          font-size: 22px;
          margin-bottom: 20px;
        }

        .settings-close-btn {
          padding: 12px 40px;
          font-size: 14px;
          margin-top: 20px;
        }
      }

      /* Bardzo małe telefony */
      @media (max-width: 360px) {
        .header h1 {
          font-size: 16px;
        }

        .info-box h3 {
          font-size: 7px;
        }

        .info-box p {
          font-size: 12px;
        }

        .keyboard {
          grid-template-columns: repeat(10, 1fr);
          gap: 2px;
        }

        .key-button {
          padding: 8px 1px;
          font-size: 10px;
        }

        .key {
          padding: 8px 10px;
          font-size: 14px;
          min-width: 40px;
        }

        .screen-content {
          font-size: 9px;
        }

        .catch-game {
          height: 220px;
        }

        .catch-target {
          width: 50px;
          height: 50px;
          font-size: 30px;
        }

        .catch-emoji {
          font-size: 35px;
        }
      }

      /* Landscape mode na telefonach */
      @media (max-height: 500px) and (orientation: landscape) {
        .header {
          padding: 8px;
          padding-top: 35px;
        }

        .header h1 {
          font-size: 16px;
          margin-bottom: 2px;
        }

        .header p {
          display: none;
        }

        .mission-info {
          grid-template-columns: repeat(4, 1fr);
          gap: 5px;
          margin-bottom: 8px;
        }

        .info-box {
          padding: 5px;
        }

        .info-box h3 {
          font-size: 8px;
          margin-bottom: 2px;
        }

        .info-box p {
          font-size: 12px;
        }

        .laptop-container {
          min-height: auto;
          padding: 8px;
        }

        .laptop-screen {
          min-height: 120px;
        }

        .keys-display {
          padding: 8px;
          margin: 5px 0;
        }

        .key {
          padding: 8px 10px;
          font-size: 14px;
        }

        .catch-game {
          height: 180px;
        }

        .warning-overlay {
          padding: 10px;
        }

        .warning-overlay h1 {
          font-size: 30px;
          margin-bottom: 10px;
        }

        .warning-overlay p {
          font-size: 11px;
          margin-bottom: 15px;
        }

        .quality-selector {
          flex-direction: row;
          margin: 10px 0;
        }
      }

      /* Efekty policji - UPGRADED */
      .police-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        animation: policeLights 0.3s infinite;
      }

      @keyframes policeLights {
        0%,
        49% {
          background: radial-gradient(
            ellipse at 30% 50%,
            rgba(255, 0, 0, 0.4) 0%,
            transparent 70%
          );
          box-shadow: inset -50vw 0 100px rgba(255, 0, 0, 0.3),
            inset 0 0 100px rgba(255, 0, 0, 0.2);
        }
        50%,
        100% {
          background: radial-gradient(
            ellipse at 70% 50%,
            rgba(0, 100, 255, 0.4) 0%,
            transparent 70%
          );
          box-shadow: inset 50vw 0 100px rgba(0, 100, 255, 0.3),
            inset 0 0 100px rgba(0, 100, 255, 0.2);
        }
      }

      .forgot-btn {
        background: linear-gradient(180deg, #ff6600 0%, #cc3300 100%);
        border: 3px solid #ff8800;
        color: #fff;
        padding: 12px 25px;
        font-size: 14px;
        font-family: "Orbitron", sans-serif;
        cursor: pointer;
        border-radius: 10px;
        margin-top: 15px;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(255, 100, 0, 0.3);
      }

      .forgot-btn:hover {
        background: linear-gradient(180deg, #ff3300 0%, #aa0000 100%);
        box-shadow: 0 6px 25px rgba(255, 0, 0, 0.5),
          0 0 40px rgba(255, 0, 0, 0.3);
        transform: translateY(-2px);
      }

      /* Mini-gra łapania emotikonek - UPGRADED */
      .catch-game {
        position: relative;
        width: 100%;
        height: 320px;
        background: linear-gradient(
          180deg,
          rgba(0, 20, 0, 0.9) 0%,
          rgba(0, 40, 20, 0.9) 100%
        );
        border: 3px solid #00ff00;
        border-radius: 15px;
        overflow: hidden;
        margin: 20px 0;
        box-shadow: 0 0 30px rgba(0, 255, 0, 0.3),
          inset 0 0 50px rgba(0, 255, 0, 0.1);
      }

      .catch-game::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 4px,
          rgba(0, 255, 0, 0.02) 4px,
          rgba(0, 255, 0, 0.02) 8px
        );
        pointer-events: none;
      }

      .catch-target {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 70px;
        height: 70px;
        border: 4px solid #00ff00;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 45px;
        background: rgba(0, 255, 0, 0.1);
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5),
          inset 0 0 20px rgba(0, 255, 0, 0.2);
        animation: targetPulse 1s ease-in-out infinite;
      }

      @keyframes targetPulse {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(0, 255, 0, 0.5),
            inset 0 0 20px rgba(0, 255, 0, 0.2);
        }
        50% {
          box-shadow: 0 0 40px rgba(0, 255, 0, 0.8),
            inset 0 0 30px rgba(0, 255, 0, 0.3);
        }
      }

      .catch-emoji {
        position: absolute;
        font-size: 55px;
        left: 50%;
        transform: translateX(-50%);
        transition: none;
        z-index: 10;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
      }

      .catch-result {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 15px;
        font-family: "Orbitron", sans-serif;
        font-size: 36px;
        color: #00ff00;
        text-shadow: 0 0 10px #00ff00, 0 0 20px rgba(0, 255, 0, 0.5);
        letter-spacing: 15px;
      }

      .catch-info {
        text-align: center;
        font-family: "Orbitron", sans-serif;
        color: #00ffff;
        font-size: 16px;
        margin: 15px 0;
        text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        letter-spacing: 1px;
      }

      .catch-errors {
        font-family: "Orbitron", sans-serif;
        color: #ff0000;
        font-size: 14px;
        text-align: center;
        text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      }

      /* Ostrzeżenie na starcie - UPGRADED */
      .warning-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          ellipse at 50% 50%,
          rgba(50, 0, 0, 0.9) 0%,
          rgba(0, 0, 0, 0.98) 70%
        );
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 99999;
        color: #ff0000;
        text-align: center;
        padding: 20px;
      }

      .warning-overlay::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(255, 0, 0, 0.03) 2px,
          rgba(255, 0, 0, 0.03) 4px
        );
        animation: warningScanlines 0.1s linear infinite;
        pointer-events: none;
      }

      @keyframes warningScanlines {
        0% {
          background-position: 0 0;
        }
        100% {
          background-position: 0 4px;
        }
      }

      .warning-overlay h1 {
        font-family: "Orbitron", sans-serif;
        font-size: clamp(48px, 12vw, 120px);
        background: linear-gradient(
          135deg,
          #ff0000 0%,
          #ff6600 50%,
          #ff0000 100%
        );
        background-size: 200% 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: warningGradient 2s ease infinite,
          warningPulse 0.5s ease infinite;
        margin-bottom: 30px;
        filter: drop-shadow(0 0 20px rgba(255, 0, 0, 0.8));
      }

      @keyframes warningGradient {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      @keyframes warningPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      .warning-overlay p {
        font-family: "Share Tech Mono", monospace;
        font-size: clamp(14px, 2.5vw, 20px);
        color: #ffff00;
        max-width: 650px;
        line-height: 1.8;
        margin-bottom: 50px;
        text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
      }

      .warning-overlay .start-btn {
        font-family: "Orbitron", sans-serif;
        background: linear-gradient(180deg, #00ff00 0%, #00aa00 100%);
        border: 4px solid #00ff00;
        color: #000;
        padding: 25px 80px;
        font-size: 22px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 15px;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 3px;
        position: relative;
        overflow: hidden;
      }

      .warning-overlay .start-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        transition: left 0.5s;
      }

      .warning-overlay .start-btn:hover::before {
        left: 100%;
      }

      .warning-overlay .start-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 40px rgba(0, 255, 0, 0.7), 0 0 80px rgba(0, 255, 0, 0.4);
      }

      /* Emoji buttons for phase 5 */
      .emoji-btn {
        background: linear-gradient(
          180deg,
          #1a2a1a 0%,
          #0a1a0a 100%
        ) !important;
        border: 3px solid #00ff00 !important;
        border-radius: 15px !important;
        transition: all 0.2s !important;
      }

      .emoji-btn:hover {
        transform: scale(1.1) !important;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5) !important;
      }

      /* Quality selector */
      .quality-selector {
        display: flex;
        gap: 15px;
        margin: 30px 0;
        flex-wrap: wrap;
        justify-content: center;
      }

      .quality-btn {
        font-family: "Orbitron", sans-serif;
        background: linear-gradient(180deg, #1a2a1a 0%, #0a1a0a 100%);
        border: 3px solid #00ff00;
        color: #00ff00;
        padding: 15px 30px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .quality-btn:hover,
      .quality-btn.active {
        background: linear-gradient(180deg, #00ff00 0%, #00aa00 100%);
        color: #000;
        box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
      }

      .quality-btn.active {
        transform: scale(1.05);
      }

      .quality-label {
        font-family: "Orbitron", sans-serif;
        color: #00ffff;
        font-size: 16px;
        margin-bottom: 10px;
        text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      }

      /* NISKA JAKOŚĆ - absolutne minimum, zero efektów */
      body.quality-low,
      body.quality-low * {
        animation: none !important;
        transition: none !important;
        box-shadow: none !important;
        text-shadow: none !important;
        filter: none !important;
        backdrop-filter: none !important;
      }

      body.quality-low .matrix-bg,
      body.quality-low::before,
      body.quality-low::after {
        display: none !important;
      }

      body.quality-low .header::before,
      body.quality-low .key::before,
      body.quality-low .btn::before,
      body.quality-low .key-button::before,
      body.quality-low .phase-indicator::before,
      body.quality-low .timer::before,
      body.quality-low .warning-overlay::before,
      body.quality-low .warning-overlay .start-btn::before,
      body.quality-low .catch-game::before,
      body.quality-low .laptop-container::before,
      body.quality-low .laptop-container::after,
      body.quality-low .laptop-screen::before,
      body.quality-low .target-info::before,
      body.quality-low .stats-panel::before,
      body.quality-low .progress-fill::before {
        display: none !important;
      }

      body.quality-low {
        background: #000 !important;
      }

      body.quality-low .header,
      body.quality-low .info-box,
      body.quality-low .laptop-container,
      body.quality-low .target-info,
      body.quality-low .stats-panel,
      body.quality-low .laptop-screen {
        background: #0a0a0a !important;
        border: 2px solid #00ff00 !important;
      }

      body.quality-low .key {
        background: #00cc00 !important;
      }

      body.quality-low .btn,
      body.quality-low .key-button {
        background: #111 !important;
      }

      body.quality-low .progress-fill {
        background: #00ff00 !important;
      }

      body.quality-low .police-overlay {
        animation: policeLightsLow 1s infinite !important;
      }

      @keyframes policeLightsLow {
        0%,
        49% {
          background: rgba(255, 0, 0, 0.3);
        }
        50%,
        100% {
          background: rgba(0, 0, 255, 0.3);
        }
      }

      body.quality-low .catch-game {
        background: #0a0a0a !important;
      }

      body.quality-low .catch-target {
        animation: none !important;
        background: rgba(0, 255, 0, 0.1) !important;
      }

      /* ŚREDNIA JAKOŚĆ - podstawowe efekty, bez ciężkich animacji */
      body.quality-medium .matrix-bg,
      body.quality-medium::after {
        display: none !important;
      }

      body.quality-medium::before {
        animation: none !important;
      }

      body.quality-medium .header::before,
      body.quality-medium .key::before,
      body.quality-medium .btn::before,
      body.quality-medium .key-button::before,
      body.quality-medium .phase-indicator::before,
      body.quality-medium .timer::before,
      body.quality-medium .warning-overlay::before,
      body.quality-medium .laptop-screen::before {
        display: none !important;
      }

      body.quality-medium .laptop-inner,
      body.quality-medium .key,
      body.quality-medium .progress-fill {
        animation: none !important;
      }

      body.quality-medium * {
        transition-duration: 0.1s !important;
      }

      body.quality-medium .police-overlay {
        animation: policeLightsLow 0.5s infinite !important;
      }

      /* WYSOKA JAKOŚĆ - wszystkie efekty (domyślne) */
      body.quality-high {
        /* wszystko włączone */
      }

      /* Przycisk ustawień */
      .settings-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: linear-gradient(180deg, #1a2a1a 0%, #0a1a0a 100%);
        border: 2px solid #00ff00;
        color: #00ff00;
        width: 45px;
        height: 45px;
        font-size: 20px;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.3s;
        z-index: 100;
      }

      .settings-btn:hover {
        background: linear-gradient(180deg, #00ff00 0%, #00aa00 100%);
        color: #000;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        transform: rotate(90deg);
      }

      /* Modal ustawień */
      .settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100000;
      }

      .settings-content {
        background: linear-gradient(
          135deg,
          rgba(0, 20, 0, 0.98) 0%,
          rgba(0, 40, 20, 0.98) 100%
        );
        border: 4px solid #00ff00;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 0 50px rgba(0, 255, 0, 0.5),
          inset 0 0 30px rgba(0, 255, 0, 0.1);
      }

      .settings-content h2 {
        font-family: "Orbitron", sans-serif;
        color: #00ff00;
        font-size: 28px;
        margin-bottom: 30px;
        text-shadow: 0 0 15px rgba(0, 255, 0, 0.8);
      }

      .settings-close-btn {
        font-family: "Orbitron", sans-serif;
        background: linear-gradient(180deg, #00ff00 0%, #00aa00 100%);
        border: none;
        color: #000;
        padding: 15px 50px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 10px;
        margin-top: 30px;
        transition: all 0.3s;
        text-transform: uppercase;
      }

      .settings-close-btn:hover {
        box-shadow: 0 0 30px rgba(0, 255, 0, 0.7);
        transform: scale(1.05);
      }

      .header {
        position: relative;
      }
    </style>
  </head>
  <body class="quality-high">
    <div class="matrix-bg"></div>

    <!-- Ostrzeżenie na starcie -->
    <div class="warning-overlay" id="warningOverlay">
      <h1>⚠️ UWAGA ⚠️</h1>
      <p>
        Ta gra zawiera <strong>MIGAJĄCE ŚWIATŁA</strong> (czerwono-niebieskie
        efekty policji) oraz <strong>GŁOŚNE DŹWIĘKI</strong> (syrena
        policyjna).<br /><br />
        Jeśli masz epilepsję lub jesteś wrażliwy na tego typu efekty, zachowaj
        ostrożność.
      </p>

      <div class="quality-label">🎮 WYBIERZ JAKOŚĆ GRAFIKI:</div>
      <div class="quality-selector">
        <button class="quality-btn" data-quality="low">🔋 NISKA</button>
        <button class="quality-btn" data-quality="medium">⚡ ŚREDNIA</button>
        <button class="quality-btn active" data-quality="high">
          🔥 WYSOKA
        </button>
      </div>

      <button class="start-btn" id="startGameBtn">▶ ROZPOCZNIJ GRĘ</button>
    </div>

    <!-- Modal ustawień -->
    <div class="settings-modal" id="settingsModal">
      <div class="settings-content">
        <h2>⚙️ USTAWIENIA</h2>

        <div class="quality-label">🎮 JAKOŚĆ GRAFIKI:</div>
        <div class="quality-selector" id="settingsQuality">
          <button class="quality-btn" data-quality="low">🔋 NISKA</button>
          <button class="quality-btn" data-quality="medium">⚡ ŚREDNIA</button>
          <button class="quality-btn active" data-quality="high">
            🔥 WYSOKA
          </button>
        </div>

        <button class="settings-close-btn" id="closeSettingsBtn">
          ✓ ZAMKNIJ
        </button>
      </div>
    </div>

    <div class="container">
      <div class="header">
        <button class="settings-btn" id="openSettingsBtn">⚙️</button>
        <h1>🔐 HACKER SIMULATOR 🔐</h1>
        <p>Zhakuj 100 celów i zostań legendą!</p>
      </div>

      <div class="mission-info">
        <div class="info-box">
          <h3>MISJA</h3>
          <p id="currentMission">1/500</p>
        </div>
        <div class="info-box">
          <h3>POSTĘP</h3>
          <p id="progressPercent">0%</p>
        </div>
        <div class="info-box">
          <h3>PRÓBY</h3>
          <p id="attempts">0</p>
        </div>
        <div class="info-box">
          <h3>CZAS GRY</h3>
          <p id="totalTime">0:00</p>
        </div>
      </div>

      <div class="game-area">
        <div class="laptop-container">
          <div class="laptop-3d">
            <div class="laptop-inner">
              <div class="laptop-screen">
                <div class="screen-content" id="terminalOutput"></div>
              </div>
              <div class="laptop-base"></div>
            </div>
          </div>

          <div class="phase-indicator" id="phaseIndicator">
            ŁADOWANIE SYSTEMU...
          </div>

          <div
            id="keysDisplay"
            class="keys-display"
            style="display: none"
          ></div>

          <div
            id="readyButton"
            style="display: none; text-align: center; margin: 20px 0"
          >
            <button
              class="btn"
              id="btnReady"
              style="font-size: 24px; padding: 20px 40px"
            >
              ✓ JESTEM GOTOWY!
            </button>
          </div>

          <div class="input-area" id="inputArea" style="display: none">
            <div
              class="input-display"
              id="inputDisplay"
              style="text-transform: none !important"
            ></div>
            <div class="keyboard" id="keyboard"></div>
            <div class="action-buttons">
              <button class="btn" id="backspaceBtn">← BACKSPACE</button>
              <button class="btn" id="submitBtn">✓ WYŚLIJ</button>
              <button class="btn" id="clearBtn">✗ WYCZYŚĆ</button>
            </div>
            <div
              id="forgotBtnContainer"
              style="text-align: center; display: none"
            >
              <button class="forgot-btn" id="forgotBtn">❓ NIE PAMIĘTAM</button>
            </div>
          </div>

          <div id="timerDisplay" class="timer" style="display: none"></div>
        </div>

        <div class="sidebar">
          <div class="target-info">
            <h2>🎯 CEL MISJI</h2>
            <div class="target-detail">
              <strong>TYP:</strong> <span id="targetType">---</span>
            </div>
            <div class="target-detail">
              <strong>TRUDNOŚĆ:</strong> <span id="difficulty">---</span>
            </div>
            <div class="target-detail">
              <strong>KLAWISZE:</strong> <span id="keysCount">---</span>
            </div>
            <div class="target-detail">
              <strong>RUNDY KODU:</strong> <span id="codeRounds">---</span>
            </div>
            <div class="target-detail">
              <strong>LIMIT CZASU:</strong> <span id="timeLimit">---</span>
            </div>
          </div>

          <div class="stats-panel">
            <h2>📊 STATYSTYKI</h2>
            <div class="stat-item">
              <strong>UKOŃCZONE:</strong> <span id="completed">0</span>
            </div>
            <div class="stat-item">
              <strong>SUKCES:</strong> <span id="successRate">0%</span>
            </div>
            <div class="stat-item">
              <strong>ŚREDNI CZAS:</strong> <span id="avgTime">0s</span>
            </div>
            <div class="stat-item">
              <strong>NAGRODY:</strong> <span id="rewards">0 🏆</span>
            </div>
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progressFill"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const TOTAL_MISSIONS = 100;
      const TUTORIAL_MISSIONS = 2;

      // Cele pogrupowane według poziomu trudności
      const targetsByDifficulty = {
        1: [
          "LAPTOP",
          "TELEFON",
          "TABLET",
          "SMARTWATCH",
          "DRUKARKA",
          "ROUTER DOMOWY",
          "KAMERA IP",
          "SMART TV",
          "KONSOLA",
          "GŁOŚNIK BT",
        ],
        2: [
          "KOMPUTER",
          "NOTEBOOK",
          "MONITOR SIECI",
          "NAS",
          "SWITCH",
          "ACCESS POINT",
          "SMART HOME",
          "TERMOSTAT",
          "LODÓWKA SMART",
          "ODKURZACZ ROBOT",
        ],
        3: [
          "STACJA ROBOCZA",
          "SERWER PLIKÓW",
          "ROUTER FIRMOWY",
          "KAMERA CCTV",
          "ALARM",
          "DOMOFON",
          "BRAMKA IOT",
          "CZYTNIK KART",
          "TERMINAL POS",
          "BANKOMAT",
        ],
        4: [
          "SERWER WWW",
          "SERWER MAIL",
          "BAZA MYSQL",
          "FIREWALL",
          "VPN",
          "PROXY",
          "LOAD BALANCER",
          "DNS SERVER",
          "KONTROLER DOMENY",
          "BACKUP SERVER",
        ],
        5: [
          "SERWER KORPORACYJNY",
          "CENTRUM DANYCH",
          "CHMURA PRYWATNA",
          "KLASTER",
          "MAINFRAME",
          "SCADA",
          "SYSTEM ERP",
          "CRM",
          "GIEŁDA",
          "BANK LOKALNY",
        ],
        6: [
          "SIEĆ RZĄDOWA",
          "SYSTEM GŁOSOWANIA",
          "SZPITAL",
          "ELEKTROWNIA",
          "OCZYSZCZALNIA",
          "LOTNISKO",
          "KOLEJ",
          "METRO",
          "URZĄD MIASTA",
          "SĄDY",
        ],
        7: [
          "MINISTERSTWO",
          "AMBASADA",
          "BAZA WOJSKOWA",
          "SATELITA",
          "CENTRUM DOWODZENIA",
          "AGENCJA WYWIADOWCZA",
          "INTERPOL",
          "EUROPOL",
          "NATO",
          "ONZ",
        ],
        8: [
          "BANK CENTRALNY",
          "GIEŁDA NARODOWA",
          "SYSTEM SWIFT",
          "REZERWA FEDERALNA",
          "KRYPTOGIEŁDA",
          "BLOCKCHAIN",
          "HEDGE FUND",
          "WALL STREET",
          "CITY LONDON",
          "IMF",
        ],
        9: [
          "CIA",
          "FBI",
          "NSA",
          "MI6",
          "MOSSAD",
          "FSB",
          "BND",
          "DGSE",
          "GCHQ",
          "PENTAGON BACKUP",
        ],
        10: [
          "PENTAGON",
          "BIAŁY DOM",
          "KREML",
          "AREA 51",
          "NORAD",
          "CERN",
          "NASA",
          "SPACE X",
          "GOOGLE HQ",
          "SKYNET",
        ],
      };

      const codeTemplates = {
        bash: [
          "chmod 777 /door",
          "ssh admin@target",
          "cat /etc/shadow",
          "rm -rf /var/log",
          "service firewall stop",
          "systemctl disable sec",
          "iptables -f",
          "kill -9 1234",
          "mount /dev/sdb1",
          "grep root /etc",
        ],
        python: [
          "import socket",
          's.connect(("target"))',
          'os.system("rm -rf")',
          "requests.post(url)",
          "subprocess.call(cmd)",
          "json.loads(data)",
          'exec(open("x.py"))',
          "hashlib.md5(pass)",
          "pickle.loads(data)",
          "sys.exit(0)",
        ],
        javascript: [
          'fetch("/api/unlock")',
          'document.cookie="x"',
          "localstorage.setitem(k)",
          "eval(atob(payload))",
          "settimeout(hack)",
          "console.log(btoa(d))",
          'window.location="/x"',
          "websocket.send(cmd)",
          "promise.all([x,y])",
          "array.from(data)",
        ],
      };

      let gameState = {
        currentMission: 1,
        phase: "memorize",
        keysToRemember: [],
        userInput: [],
        // Faza 2 - zapamiętywanie
        memoryRoundsNeeded: 1,
        currentMemoryRound: 0,
        // Faza 3 - wpisywanie komend
        codeRoundsNeeded: 1,
        currentCodeRound: 0,
        currentCode: "",
        wordsToFind: [],
        // Faza 4 - hasło/hasła
        finalCode: "",
        finalCodes: [], // wiele haseł do znalezienia
        currentFinalRound: 0,
        finalRoundsNeeded: 1,
        finalAttempts: 0, // próby w fazie 4
        finalJSCode: "",
        // Tryb policji (po nieudanej fazie 4)
        policeMode: false,
        policeTimeLimit: 210, // 3.5 minuty
        homePassword: "",
        // Stan przed policją (do przywrócenia po ucieczce)
        savedState: null,
        // Blokada spamu przycisków
        isProcessing: false,
        // Ogólne
        attempts: 0,
        startTime: null,
        timerInterval: null,
        timeLimit: 0,
        stats: {
          completed: 0,
          totalAttempts: 0,
          totalTime: 0,
          rewards: 0,
        },
      };

      function loadGame() {
        const saved = localStorage.getItem("hackerSimulator");
        if (saved) {
          const data = JSON.parse(saved);
          gameState.currentMission = data.currentMission || 1;
          gameState.stats = data.stats || gameState.stats;
          updateUI();
        }
      }

      function saveGame() {
        localStorage.setItem(
          "hackerSimulator",
          JSON.stringify({
            currentMission: gameState.currentMission,
            stats: gameState.stats,
          })
        );
      }

      function generateMission(missionNumber) {
        // TRUDNOŚĆ ZALEŻY OD NUMERU MISJI
        // Misje 1-2 (tutorial): poziom 1
        // Misje 3-12: poziom 2
        // Misje 13-22: poziom 3
        // ... itd do poziomu 10
        let difficulty;
        if (missionNumber <= TUTORIAL_MISSIONS) {
          difficulty = 1; // Tutorial = zawsze 1
        } else {
          // Po tutorialu: co 10 misji +1 poziom
          difficulty = Math.min(
            10,
            2 + Math.floor((missionNumber - TUTORIAL_MISSIONS - 1) / 10)
          );
        }

        // Wybierz losowy cel z odpowiedniego poziomu trudności
        const targets = targetsByDifficulty[difficulty];
        const targetName = targets[Math.floor(Math.random() * targets.length)];

        // Im trudniejsze, tym dłuższe hasło w fazie 1/2 (od 3 do 6 znaków)
        const keysCount = Math.min(3 + Math.floor(difficulty / 2), 6);

        // Im trudniejsze, tym więcej rund fazy 2 (do 3)
        const memoryRounds = Math.min(1 + Math.floor(difficulty / 4), 3);

        // Im trudniejsze, tym więcej rund fazy 3 (do 5)
        const codeRounds = Math.min(1 + Math.floor(difficulty / 2), 5);

        // Im trudniejsze, tym więcej haseł w fazie 4 (do 5)
        const finalRounds = Math.min(1 + Math.floor(difficulty / 2), 5);

        // Im trudniejsze, tym dłuższe hasła w fazie 4 (4-8 cyfr)
        const passwordLength = Math.min(4 + Math.floor(difficulty / 3), 8);

        const hasTimeLimit = missionNumber > TUTORIAL_MISSIONS;
        // Zmniejszone czasy: łatwe 90s (1.5 min), trudne 150s (2.5 min)
        const timeLimit = hasTimeLimit ? 90 + difficulty * 6 : 0;

        return {
          number: missionNumber,
          type: targetName,
          difficulty: difficulty,
          keysCount: keysCount,
          memoryRounds: memoryRounds,
          codeRounds: codeRounds,
          finalRounds: finalRounds,
          passwordLength: passwordLength,
          timeLimit: timeLimit,
        };
      }

      function generateKeys(count) {
        const allKeys = "QWERTYUIOPASDFGHJKLZXCVBNM1234567890".split("");
        const keys = [];
        for (let i = 0; i < count; i++) {
          keys.push(allKeys[Math.floor(Math.random() * allKeys.length)]);
        }
        return keys;
      }

      function generateCode() {
        return "return grant(access)";
      }

      function generatePassword(length) {
        // Generuj hasło o podanej długości (4-8 cyfr)
        const min = Math.pow(10, length - 1);
        const max = Math.pow(10, length) - 1;
        return Math.floor(min + Math.random() * (max - min + 1)).toString();
      }

      function generateFullCode() {
        const mission = generateMission(gameState.currentMission);
        const difficulty = mission.difficulty;
        const passLength = mission.passwordLength || 4;

        // Generuj wiele haseł (do 5) zależnie od trudności, każde o długości passwordLength
        const passwords = [];
        for (let i = 0; i < mission.finalRounds; i++) {
          passwords.push(generatePassword(passLength));
        }

        // Komendy dla każdego poziomu trudności (10-15 komend na poziom)
        const commandsByDifficulty = {
          1: [
            'print("hello")',
            'echo "test"',
            "ls -la",
            "cd /home",
            "pwd",
            "cat file.txt",
            "mkdir folder",
            "touch file",
            "rm temp",
            "cp a b",
          ],
          2: [
            "chmod 777 file",
            "chown user file",
            'grep "text" file',
            "find / -name x",
            "wget url",
            "curl api.com",
            "tar -xvf file",
            "unzip archive",
            "ping host",
            "ifconfig",
          ],
          3: [
            "ssh user@host",
            "scp file server:",
            "rsync -av src dst",
            "mount /dev/sda1",
            "umount /mnt",
            "fdisk -l",
            "df -h",
            "ps aux",
            "kill -9 1234",
            "top -n 1",
            "htop",
            "netstat -an",
          ],
          4: [
            "iptables -A INPUT",
            "systemctl start x",
            "service nginx stop",
            "apt install pkg",
            "yum update",
            "pip install lib",
            "npm install",
            "git clone repo",
            "docker run img",
            "kubectl get pods",
            "mysql -u root",
            "psql -U admin",
          ],
          5: [
            "socket.connect(host)",
            'fetch("/api/data")',
            "axios.post(url)",
            "request.get(api)",
            "subprocess.call(cmd)",
            'os.system("cmd")',
            'exec(open("x.py"))',
            "eval(code)",
            "import socket",
            "from os import *",
            'require("http")',
            'const fs = require("fs")',
          ],
          6: [
            'chmod("/etc/shadow", 777)',
            "socket.connect(host, port)",
            'fetch("/api").then(cb)',
            'sudo("rm -rf /var")',
            "exec(cmd, args)",
            "kill(pid, SIGTERM)",
            "hashlib.md5(data)",
            "base64.encode(str)",
            "crypto.decrypt(key)",
            "jwt.verify(token)",
            "bcrypt.hash(pass)",
            "aes.encrypt(data, key)",
          ],
          7: [
            "if (auth()) { grant() }",
            "while (true) { scan() }",
            "for (i in range(10))",
            "try { hack() } catch {}",
            "socket.bind(0.0.0.0)",
            "server.listen(8080)",
            'db.query("SELECT *")',
            "redis.set(key, val)",
            "mongo.find({admin:1})",
            "elastic.search(query)",
            "kafka.produce(msg)",
            "rabbitmq.publish(data)",
          ],
          8: [
            "if (login(creds)) { return grant(access) }",
            "socket.connect(config.host, config.port)",
            'fetch("/api/auth", opts).then(resolve)',
            'sudo("rm -rf /var/log/*", force: true)',
            "exec(command, args, { shell: true })",
            'crypto.createCipher("aes256", key)',
            "jwt.sign(payload, secret, options)",
            "bcrypt.compare(pass, hash, callback)",
            "db.collection.aggregate([{$match}])",
            "axios.interceptors.request.use(cfg)",
          ],
          9: [
            "exploit.execute(target, payload, callback)",
            "metasploit.run(module, options, handler)",
            'nmap.scan(subnet, "-sV -sC -O -A")',
            'sqlmap.inject(url, "--dbs --tables")',
            "hydra.bruteforce(host, wordlist, proto)",
            'john.crack(hashfile, "--wordlist=rockyou")',
            "aircrack.capture(interface, channel)",
            'wireshark.filter("tcp.port == 443")',
            "burpsuite.intercept(request, response)",
            "cobalt.beacon(target, listener, payload)",
          ],
          10: [
            "pentagon.breach(firewall, { stealth: true, timeout: 0 })",
            "skynet.override(security, credentials, backdoor)",
            "matrix.inject(mainframe, exploit, rootkit)",
            "zero_day.execute(target, payload, persistence)",
            "quantum.decrypt(encryption, superposition)",
            "neural.hack(ai_defense, bypass, escalate)",
            "blackhat.infiltrate(network, pivot, exfil)",
            "apt.deploy(implant, c2_server, callback)",
            "ransomware.encrypt(drives, bitcoin_wallet)",
            "botnet.command(zombies, ddos_target, amplify)",
          ],
        };

        // Wybierz komendy dla danego poziomu
        const commands =
          commandsByDifficulty[difficulty] || commandsByDifficulty[1];

        // Wylosuj komendy do wpisania
        const wordsToFind = [];
        const shuffled = [...commands].sort(() => Math.random() - 0.5);
        for (let i = 0; i < mission.codeRounds; i++) {
          wordsToFind.push(shuffled[i % shuffled.length]);
        }

        // Generuj kod z wieloma hasłami
        const jsCode = `function authenticate() {
    const config = {
        host: "target.sys",
        port: 8443,
        key1: ${passwords[0]}${
          passwords[1]
            ? `,
        key2: ${passwords[1]}`
            : ""
        }${
          passwords[2]
            ? `,
        key3: ${passwords[2]}`
            : ""
        }${
          passwords[3]
            ? `,
        key4: ${passwords[3]}`
            : ""
        }${
          passwords[4]
            ? `,
        key5: ${passwords[4]}`
            : ""
        }
    };
    
    const credentials = {
        user: "admin",
        pass: "root"
    };
    
    if (login(credentials)) {
        chmod("/etc/shadow", 0777);
        return grant(access);
    }
    
    function exec(command, args) {
        sudo("rm -rf /var/log/*");
        kill(process.pid, SIGTERM);
    }
    
    socket.connect(config.host, port);
    fetch("/api/auth", options).then(callback);
}`;

        return {
          code: jsCode,
          passwords: passwords,
          password: passwords[0],
          wordsToFind: wordsToFind,
        };
      }

      // Generuj kod z aktualnym hasłem dla fazy 4
      function generateFinalCodeDisplay(passwordIndex) {
        const password = gameState.finalCodes[passwordIndex];
        const passLength = password.length;

        return `function authenticate() {
    const config = {
        host: "target.sys",
        port: 8443,
        timeout: 30000
    };
    
    const security = {
        password${passwordIndex + 1}: ${password}
    };
    
    if (verify(security.password${passwordIndex + 1})) {
        return grant(access);
    }
    
    socket.connect(config.host);
}`;
      }

      function generateFinalCode() {
        return generateFullCode();
      }

      // Generuj hasło do zabezpieczenia domu (tryb policji)
      function generateHomePassword() {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let password = "";
        for (let i = 0; i < 8; i++) {
          password += chars[Math.floor(Math.random() * chars.length)];
        }
        return password;
      }

      function addTerminalLine(text, isCommand = false) {
        const terminal = document.getElementById("terminalOutput");
        const line = document.createElement("div");
        line.className = "code-line";

        if (isCommand) {
          line.innerHTML = `<span class="command-prompt">root@hacker:~$</span> ${text}`;
        } else {
          line.innerHTML = text;
        }

        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
      }

      function clearTerminal() {
        document.getElementById("terminalOutput").innerHTML = "";
      }

      function startMission() {
        const mission = generateMission(gameState.currentMission);

        // Generuj pełny kod na początku misji
        const fullCodeData = generateFullCode();
        gameState.finalJSCode = fullCodeData.code;
        gameState.finalCodes = fullCodeData.passwords;
        gameState.finalCode = fullCodeData.passwords[0];
        gameState.wordsToFind = fullCodeData.wordsToFind;
        gameState.finalRoundsNeeded = mission.finalRounds;
        gameState.currentFinalRound = 0;
        gameState.finalAttempts = 0; // Reset prób w fazie 4

        // Reset trybu policji
        gameState.policeMode = false;

        gameState.keysToRemember = generateKeys(mission.keysCount);
        gameState.memoryRoundsNeeded = mission.memoryRounds;
        gameState.currentMemoryRound = 0;
        gameState.codeRoundsNeeded = mission.codeRounds;
        gameState.currentCodeRound = 0;
        gameState.userInput = [];
        gameState.phase = "memorize";
        gameState.timeLimit = mission.timeLimit;
        gameState.startTime = Date.now();

        clearTerminal();
        addTerminalLine("═══════════════════════════════════════════");
        addTerminalLine(`INICJALIZACJA SYSTEMU HAKOWANIA...`);
        addTerminalLine(`CEL: ${mission.type} #${mission.number}`);
        addTerminalLine(`POZIOM ZABEZPIECZEŃ: ${mission.difficulty}/10`);
        addTerminalLine("═══════════════════════════════════════════");
        addTerminalLine("");
        addTerminalLine("Analizowanie luk w zabezpieczeniach...");
        addTerminalLine("Przygotowywanie exploita...");
        addTerminalLine("");
        addTerminalLine("GOTOWE! Zapamiętaj sekwencję klawiszy:");

        document.getElementById("targetType").textContent = mission.type;
        document.getElementById("difficulty").textContent = `${
          mission.difficulty
        }/10 ${"⭐".repeat(mission.difficulty)}`;
        document.getElementById("keysCount").textContent = mission.keysCount;
        document.getElementById(
          "codeRounds"
        ).textContent = `F2:${mission.memoryRounds}x F3:${mission.codeRounds}x F4:${mission.finalRounds}x`;
        document.getElementById("timeLimit").textContent =
          mission.timeLimit > 0
            ? `${mission.timeLimit}s`
            : "Bez limitu (Tutorial)";

        showMemorizePhase();
      }

      function showMemorizePhase() {
        gameState.phase = "memorize";

        // Generuj nowe klawisze dla każdej rundy
        if (gameState.currentMemoryRound > 0) {
          const mission = generateMission(gameState.currentMission);
          gameState.keysToRemember = generateKeys(mission.keysCount);
        }

        document.getElementById(
          "phaseIndicator"
        ).textContent = `🧠 FAZA 1: ZAPAMIĘTAJ KLAWISZE (${
          gameState.currentMemoryRound + 1
        }/${gameState.memoryRoundsNeeded})`;

        const keysDisplay = document.getElementById("keysDisplay");
        keysDisplay.innerHTML = "";
        keysDisplay.style.display = "flex";

        gameState.keysToRemember.forEach((key, index) => {
          setTimeout(() => {
            const keyElement = document.createElement("div");
            keyElement.className = "key";
            keyElement.textContent = key;
            keysDisplay.appendChild(keyElement);
          }, index * 200);
        });

        document.getElementById("inputArea").style.display = "none";
        document.getElementById("readyButton").style.display = "none";

        setTimeout(() => {
          document.getElementById("readyButton").style.display = "block";
        }, gameState.keysToRemember.length * 200 + 1000);
      }

      document.getElementById("btnReady").onclick = () => {
        document.getElementById("readyButton").style.display = "none";
        if (gameState.policeMode) {
          showPoliceInputPhase();
        } else {
          showInputPhase();
        }
      };

      function showInputPhase() {
        gameState.phase = "input";
        gameState.userInput = [];
        document.getElementById(
          "phaseIndicator"
        ).textContent = `⌨️ FAZA 2: WPISZ KLAWISZE Z PAMIĘCI (${
          gameState.currentMemoryRound + 1
        }/${gameState.memoryRoundsNeeded})`;
        document.getElementById("keysDisplay").style.display = "none";
        document.getElementById("inputArea").style.display = "block";
        document.getElementById("inputDisplay").textContent = "";

        // Pokaż przycisk "Nie pamiętam"
        document.getElementById("forgotBtnContainer").style.display = "block";

        createKeyboard();
        startTimer();
      }

      function createKeyboard() {
        const keyboard = document.getElementById("keyboard");
        keyboard.innerHTML = "";
        keyboard.style.display = "grid";

        const keys = "QWERTYUIOP|ASDFGHJKL|ZXCVBNM|1234567890".split("|");

        keys.forEach((row) => {
          row.split("").forEach((key) => {
            const button = document.createElement("button");
            button.className = "key-button";
            button.textContent = key;
            button.onclick = () => addKey(key);
            keyboard.appendChild(button);
          });
        });
      }

      function addKey(key) {
        const validPhases = [
          "input",
          "code",
          "final",
          "police_input",
          "police_code",
          "police_final",
          "phase5_commands",
        ];
        if (!validPhases.includes(gameState.phase)) return;

        gameState.userInput.push(key);
        updateInputDisplay();
      }

      function updateInputDisplay() {
        const display = document.getElementById("inputDisplay");
        if (gameState.phase === "input" || gameState.phase === "police_input") {
          display.textContent = gameState.userInput.join(" ");
        } else {
          display.textContent = gameState.userInput.join("");
        }
      }

      document.getElementById("backspaceBtn").onclick = () => {
        gameState.userInput.pop();
        updateInputDisplay();
      };

      document.getElementById("clearBtn").onclick = () => {
        gameState.userInput = [];
        updateInputDisplay();
      };

      document.getElementById("submitBtn").onclick = () => {
        // Blokada spamu - nie można klikać wielokrotnie
        if (gameState.isProcessing) return;
        gameState.isProcessing = true;

        if (gameState.phase === "input") {
          checkKeysInput();
        } else if (gameState.phase === "code") {
          checkCodeInput();
        } else if (gameState.phase === "final") {
          checkFinalInput();
        } else if (gameState.phase === "phase5_commands") {
          checkPhase5Input();
        } else if (gameState.phase.startsWith("police_")) {
          checkPoliceInput();
        }

        // Odblokuj po 500ms
        setTimeout(() => {
          gameState.isProcessing = false;
        }, 500);
      };

      // Przycisk "Nie pamiętam" - automatycznie włącza policję
      document.getElementById("forgotBtn").onclick = () => {
        // Blokada spamu
        if (gameState.isProcessing) return;
        gameState.isProcessing = true;

        document.getElementById("forgotBtnContainer").style.display = "none";

        if (gameState.policeMode) {
          // W trybie policji - od razu łapią
          showMessage("🚔 NIE PAMIĘTASZ? POLICJA CIĘ ŁAPIE!", "error");
          addTerminalLine("");
          addTerminalLine(
            '<span style="color: #ff0000;">Nie pamiętasz kodu? ZŁAPANY!</span>'
          );
          setTimeout(() => {
            policeCaught();
            gameState.isProcessing = false;
          }, 2000);
        } else {
          // Normalny tryb - włącz policję
          showMessage("🚨 NIE PAMIĘTASZ? POLICJA JEDZIE!", "error");
          addTerminalLine("");
          addTerminalLine(
            '<span style="color: #ff0000;">🚨 Nie pamiętasz hasła? ALARM!</span>'
          );
          gameState.attempts++;
          updateUI();
          setTimeout(() => {
            startPoliceMode();
            gameState.isProcessing = false;
          }, 2000);
        }
      };

      function checkKeysInput() {
        const correct =
          gameState.userInput.join("") === gameState.keysToRemember.join("");

        if (correct) {
          gameState.currentMemoryRound++;

          if (gameState.currentMemoryRound < gameState.memoryRoundsNeeded) {
            // Kolejna runda fazy 2
            showMessage("✓ SEKWENCJA POPRAWNA!", "success");
            addTerminalLine("");
            addTerminalLine("✓ Sekwencja klawiszy zaakceptowana!", true);
            addTerminalLine(
              `Przygotowuję kolejną sekwencję... (${
                gameState.currentMemoryRound + 1
              }/${gameState.memoryRoundsNeeded})`
            );

            setTimeout(() => {
              showMemorizePhase();
            }, 1500);
          } else {
            // Wszystkie rundy fazy 2 ukończone - przechodź do fazy 3
            showMessage("✓ WSZYSTKIE SEKWENCJE POPRAWNE!", "success");
            addTerminalLine("");
            addTerminalLine("✓ Wszystkie sekwencje zaakceptowane!", true);
            addTerminalLine("Ładowanie kodu do analizy...");

            setTimeout(() => {
              showCodePhase();
            }, 1500);
          }
        } else {
          // BŁĄD = POLICJA!
          showMessage("✗ BŁĘDNA SEKWENCJA!", "error");
          addTerminalLine("");
          addTerminalLine(
            '<span style="color: #ff0000;">🚨 WYKRYTO WŁAMANIE! POLICJA JEDZIE!</span>'
          );
          gameState.attempts++;
          updateUI();

          setTimeout(() => {
            startPoliceMode();
          }, 2000);
        }
      }

      function showCodePhase() {
        gameState.phase = "code";
        gameState.userInput = [];

        // Pobierz komendę do wpisania z listy
        gameState.currentCode =
          gameState.wordsToFind[gameState.currentCodeRound];

        document.getElementById(
          "phaseIndicator"
        ).textContent = `💻 FAZA 3: PRZEPISZ KOMENDĘ (${
          gameState.currentCodeRound + 1
        }/${gameState.codeRoundsNeeded})`;

        clearTerminal();

        // Wyświetl kod JS
        const lines = gameState.finalJSCode.split("\n");
        lines.forEach((line) => {
          addTerminalLine(line);
        });

        addTerminalLine("");
        addTerminalLine(
          '<span class="command-prompt">root@hacker:~$</span> <span id="codeTarget" style="color: #ffff00;">' +
            gameState.currentCode +
            "</span>"
        );

        // Pokaż input area i klawiaturę
        document.getElementById("inputArea").style.display = "block";
        document.getElementById("inputDisplay").textContent = "";

        // Ukryj przycisk "Nie pamiętam" w fazie 3
        document.getElementById("forgotBtnContainer").style.display = "none";

        createCodeKeyboard();
      }

      function createCodeKeyboard() {
        const keyboard = document.getElementById("keyboard");
        keyboard.innerHTML = "";
        keyboard.style.display = "grid";
        keyboard.style.gridTemplateColumns =
          "repeat(auto-fit, minmax(45px, 1fr))";

        const specialKeys = [
          ["q", "w", "e", "r", "t", "y", "u", "i", "o", "p"],
          ["a", "s", "d", "f", "g", "h", "j", "k", "l"],
          ["z", "x", "c", "v", "b", "n", "m"],
          ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"],
          [" ", ".", ",", "/", "\\", "-", "_", "=", "+", "*"],
          ["(", ")", "[", "]", "{", "}", "<", ">", "|", "&"],
          [":", ";", '"', "'", "!", "?", "@", "#", "$", "%"],
        ];

        specialKeys.forEach((row) => {
          row.forEach((key) => {
            const button = document.createElement("button");
            button.className = "key-button";
            button.textContent = key === " " ? "SPACJA" : key;
            button.style.fontSize = "clamp(12px, 1.8vw, 16px)";
            button.style.padding = "clamp(8px, 2vw, 12px)";
            button.onclick = () => addKey(key);
            keyboard.appendChild(button);
          });
        });
      }

      function checkCodeInput() {
        const userCode = gameState.userInput.join("");
        const correctCode = gameState.currentCode;

        if (userCode === correctCode) {
          addTerminalLine("");
          addTerminalLine("✓ Kod wykonany pomyślnie!");

          gameState.currentCodeRound++;

          if (gameState.currentCodeRound < gameState.codeRoundsNeeded) {
            showMessage("✓ KOD POPRAWNY!", "success");
            setTimeout(() => {
              showCodePhase();
            }, 1500);
          } else {
            showMessage("✓ WSZYSTKIE KODY WYKONANE!", "success");
            setTimeout(() => {
              showFinalPhase();
            }, 1500);
          }
        } else {
          // BŁĄD = POLICJA!
          showMessage("❌ BŁĄD W KODZIE!", "error");
          addTerminalLine("");
          addTerminalLine(
            '<span style="color: #ff0000;">🚨 WYKRYTO WŁAMANIE! POLICJA JEDZIE!</span>'
          );
          gameState.attempts++;
          updateUI();

          setTimeout(() => {
            startPoliceMode();
          }, 2000);
        }
      }

      function showFinalPhase() {
        // Najpierw mini-gra łapania emotikonek!
        startCatchGame();
      }

      // ============ MINI-GRA ŁAPANIA EMOTIKONEK ============

      const hackerEmojis = [
        "💻",
        "🖥️",
        "⌨️",
        "🔓",
        "🔐",
        "💾",
        "📡",
        "🛡️",
        "⚡",
        "🔌",
        "🖱️",
        "📟",
      ];

      let catchGameState = {
        currentIndex: 0,
        password: "",
        revealedChars: [],
        errors: 0,
        maxErrors: 4,
        emojiY: -60,
        targetY: 150,
        speed: 2,
        animationId: null,
        currentEmoji: "",
        isMoving: false,
      };

      function startCatchGame() {
        gameState.phase = "catch_game";

        // Ustaw aktualne hasło
        gameState.finalCode = gameState.finalCodes[gameState.currentFinalRound];
        catchGameState.password = gameState.finalCode;
        catchGameState.currentIndex = 0;
        catchGameState.revealedChars = [];
        catchGameState.errors = 0;
        catchGameState.maxErrors = 4;

        // Prędkość zależy od trudności (1-10)
        const mission = generateMission(gameState.currentMission);
        catchGameState.speed = 1.5 + mission.difficulty * 0.3; // 1.8 do 4.5

        document.getElementById(
          "phaseIndicator"
        ).textContent = `🎯 ZŁAP EMOTIKONY! (${
          gameState.currentFinalRound + 1
        }/${gameState.finalRoundsNeeded})`;

        clearTerminal();
        addTerminalLine("═══════════════════════════════════════════");
        addTerminalLine("🎯 ZŁAP EMOTIKONY ABY ODKRYĆ HASŁO!");
        addTerminalLine("═══════════════════════════════════════════");
        addTerminalLine("");
        addTerminalLine("Naciśnij SPACJĘ gdy emotikona jest w ramce!");
        addTerminalLine(`Hasło ma ${catchGameState.password.length} znaków.`);
        addTerminalLine(`Błędy: 0/${catchGameState.maxErrors}`);

        // Ukryj input area
        document.getElementById("inputArea").style.display = "none";
        document.getElementById("forgotBtnContainer").style.display = "none";

        // Stwórz obszar gry
        const keysDisplay = document.getElementById("keysDisplay");
        keysDisplay.innerHTML = "";
        keysDisplay.style.display = "block";
        keysDisplay.innerHTML = `
                <div class="catch-info">Naciśnij SPACJĘ gdy emotikona jest w ramce!</div>
                <div class="catch-result" id="catchResult">${"_".repeat(
                  catchGameState.password.length
                )}</div>
                <div class="catch-game" id="catchGameArea">
                    <div class="catch-target" id="catchTarget" style="top: 150px;">🎯</div>
                    <div class="catch-emoji" id="catchEmoji" style="top: -60px;">💻</div>
                </div>
                <div class="catch-errors" id="catchErrors">Błędy: 0/${
                  catchGameState.maxErrors
                }</div>
            `;

        // Startuj pierwszą emotikonę
        setTimeout(() => {
          launchNextEmoji();
        }, 500);
      }

      function launchNextEmoji() {
        if (catchGameState.currentIndex >= catchGameState.password.length) {
          // Wszystkie złapane - pokaż hasło do wpisania
          catchGameComplete();
          return;
        }

        // Losowa emotikona
        catchGameState.currentEmoji =
          hackerEmojis[Math.floor(Math.random() * hackerEmojis.length)];

        const emojiEl = document.getElementById("catchEmoji");
        const targetEl = document.getElementById("catchTarget");

        if (!emojiEl || !targetEl) return;

        // Ustaw emotikonę na górze i cel
        emojiEl.textContent = catchGameState.currentEmoji;
        emojiEl.style.top = "-60px";
        targetEl.textContent = catchGameState.currentEmoji;

        catchGameState.emojiY = -60;
        catchGameState.targetY = 120 + Math.random() * 60; // Losowa pozycja celu
        targetEl.style.top = catchGameState.targetY + "px";

        catchGameState.isMoving = true;

        // Animuj spadanie
        animateEmoji();
      }

      function animateEmoji() {
        if (!catchGameState.isMoving) return;

        const emojiEl = document.getElementById("catchEmoji");
        if (!emojiEl) return;

        catchGameState.emojiY += catchGameState.speed;
        emojiEl.style.top = catchGameState.emojiY + "px";

        // Jeśli emotikona przeleciała przez cel - błąd
        if (catchGameState.emojiY > 280) {
          catchMiss();
          return;
        }

        catchGameState.animationId = requestAnimationFrame(animateEmoji);
      }

      function catchAttempt() {
        if (!catchGameState.isMoving) return;
        if (gameState.phase !== "catch_game") return;

        catchGameState.isMoving = false;
        cancelAnimationFrame(catchGameState.animationId);

        // Sprawdź czy emotikona jest w ramce lub na linii (z tolerancją 10px)
        // Emotikona ma 50px wysokości, ramka 60px
        const emojiTop = catchGameState.emojiY;
        const emojiBottom = catchGameState.emojiY + 50;
        const targetTop = catchGameState.targetY;
        const targetBottom = catchGameState.targetY + 60;

        // Tolerancja 10px - emotikona może wystawać max 10px poza ramkę
        const tolerance = 10;

        if (
          emojiTop >= targetTop - tolerance &&
          emojiBottom <= targetBottom + tolerance
        ) {
          // ZŁAPANE!
          catchSuccess();
        } else {
          // PUDŁO!
          catchMiss();
        }
      }

      function catchSuccess() {
        const char = catchGameState.password[catchGameState.currentIndex];
        catchGameState.revealedChars.push(char);
        catchGameState.currentIndex++;

        // Aktualizuj wyświetlane hasło
        let displayStr = "";
        for (let i = 0; i < catchGameState.password.length; i++) {
          if (i < catchGameState.revealedChars.length) {
            displayStr += catchGameState.revealedChars[i];
          } else {
            displayStr += "_";
          }
        }

        const resultEl = document.getElementById("catchResult");
        if (resultEl) resultEl.textContent = displayStr;

        showMessage("✓ ZŁAPANE!", "success");

        // Następna emotikona
        setTimeout(() => {
          launchNextEmoji();
        }, 800);
      }

      function catchMiss() {
        catchGameState.errors++;

        const errorsEl = document.getElementById("catchErrors");
        if (errorsEl)
          errorsEl.textContent = `Błędy: ${catchGameState.errors}/${catchGameState.maxErrors}`;

        addTerminalLine(
          `<span style="color: #ff0000;">Błędy: ${catchGameState.errors}/${catchGameState.maxErrors}</span>`
        );

        if (catchGameState.errors >= catchGameState.maxErrors) {
          // Za dużo błędów - POLICJA!
          showMessage("🚨 ZA DUŻO BŁĘDÓW! POLICJA!", "error");
          catchGameState.isMoving = false;
          cancelAnimationFrame(catchGameState.animationId);

          document.getElementById("keysDisplay").style.display = "none";

          setTimeout(() => {
            startPoliceMode30s();
          }, 1500);
        } else {
          showMessage("✗ PUDŁO!", "error");

          // Powtórz tę samą literę
          setTimeout(() => {
            launchNextEmoji();
          }, 800);
        }
      }

      function catchGameComplete() {
        catchGameState.isMoving = false;

        showMessage("✓ HASŁO ODKRYTE!", "success");

        document.getElementById("keysDisplay").style.display = "none";

        // Teraz pokaż hasło do wpisania
        setTimeout(() => {
          showFinalPhaseInput();
        }, 1500);
      }

      // Policja z 30 sekundami (za błędy w mini-grze)
      function startPoliceMode30s() {
        gameState.policeMode = true;
        gameState.phase = "police_memorize";
        gameState.homePassword = generateHomePassword();
        gameState.currentMemoryRound = 0;
        gameState.currentCodeRound = 0;

        gameState.keysToRemember = generateKeys(6);
        gameState.memoryRoundsNeeded = 1;

        const policeCommands = ["lock(door)", "secure(home)", "close(window)"];
        gameState.codeRoundsNeeded = 3;
        gameState.wordsToFind = policeCommands;

        // Zapisz stan
        gameState.savedState = {
          phase: "catch_game",
          currentFinalRound: gameState.currentFinalRound,
          finalRoundsNeeded: gameState.finalRoundsNeeded,
          finalCode: gameState.finalCode,
          finalCodes: [...gameState.finalCodes],
          timeLimit: gameState.timeLimit,
        };

        stopTimer();
        startPoliceLights();
        startPoliceSiren();

        // TYLKO 30 SEKUND!
        startPoliceTimer30s();

        clearTerminal();
        addTerminalLine(
          '<span style="color: #ff0000;">🚨🚨🚨 ALARM! POLICJA JEDZIE! 🚨🚨🚨</span>'
        );
        addTerminalLine("");
        addTerminalLine('<span style="color: #ff0000;">ZA DUŻO BŁĘDÓW!</span>');
        addTerminalLine("Masz 2.5 MINUTY!");

        document.getElementById("phaseIndicator").textContent =
          "🚨 POLICJA! 2.5 MIN!";

        showPoliceMemorizePhase();
      }

      function startPoliceTimer30s() {
        stopTimer();

        let timeLeft = 150; // 2.5 minuty
        const timerDisplay = document.getElementById("timerDisplay");
        timerDisplay.style.display = "block";
        timerDisplay.style.color = "#ff0000";
        timerDisplay.style.borderColor = "#ff0000";
        timerDisplay.textContent = `🚨 ${timeLeft}s`;

        gameState.timerInterval = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = `🚨 ${timeLeft}s`;

          if (timeLeft <= 0) {
            stopTimer();
            policeCaught();
          }
        }, 1000);
      }

      function showFinalPhaseInput() {
        gameState.phase = "final";
        gameState.userInput = [];

        document.getElementById(
          "phaseIndicator"
        ).textContent = `🔍 ZNAJDŹ HASŁO W KODZIE (${
          gameState.currentFinalRound + 1
        }/${gameState.finalRoundsNeeded})`;

        clearTerminal();
        addTerminalLine("═══════════════════════════════════════════");
        addTerminalLine(
          `🎯 ZNAJDŹ password${gameState.currentFinalRound + 1} W KODZIE`
        );
        addTerminalLine("═══════════════════════════════════════════");
        addTerminalLine("");
        addTerminalLine("Odkryłeś hasło! Teraz znajdź je w kodzie:");
        addTerminalLine("");

        // Generuj kod z aktualnym hasłem
        const codeDisplay = generateFinalCodeDisplay(
          gameState.currentFinalRound
        );
        const lines = codeDisplay.split("\n");
        lines.forEach((line) => {
          addTerminalLine(line);
        });

        addTerminalLine("");
        addTerminalLine(`Wpisz password${gameState.currentFinalRound + 1}:`);

        document.getElementById("inputArea").style.display = "block";
        document.getElementById("inputDisplay").textContent = "";
        document.getElementById("forgotBtnContainer").style.display = "none";

        createNumberKeyboard();
      }

      function createNumberKeyboard() {
        const keyboard = document.getElementById("keyboard");
        keyboard.innerHTML = "";
        keyboard.style.display = "grid";
        keyboard.style.gridTemplateColumns = "repeat(5, 1fr)";

        const numbers = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"];

        numbers.forEach((num) => {
          const button = document.createElement("button");
          button.className = "key-button";
          button.textContent = num;
          button.style.padding = "20px";
          button.style.fontSize = "20px";
          button.onclick = () => addKey(num);
          keyboard.appendChild(button);
        });
      }

      function checkFinalInput() {
        const userCode = gameState.userInput.join("");

        if (userCode === gameState.finalCode) {
          gameState.currentFinalRound++;

          if (gameState.currentFinalRound < gameState.finalRoundsNeeded) {
            // Kolejne hasło do znalezienia
            showMessage("✓ HASŁO POPRAWNE!", "success");
            setTimeout(() => {
              showFinalPhase();
            }, 1500);
          } else {
            // Wszystkie hasła znalezione!
            // Od poziomu 7+ - FAZA 5 (policja się domyśliła)
            const mission = generateMission(gameState.currentMission);
            if (mission.difficulty >= 7) {
              showMessage("⚠️ POLICJA SIĘ DOMYŚLIŁA!", "error");
              setTimeout(() => {
                startPhase5();
              }, 2000);
            } else {
              missionComplete();
            }
          }
        } else {
          // BŁĄD = POLICJA!
          showMessage("❌ BŁĘDNE HASŁO!", "error");
          addTerminalLine("");
          addTerminalLine(
            '<span style="color: #ff0000;">🚨 WYKRYTO WŁAMANIE! POLICJA JEDZIE!</span>'
          );
          gameState.attempts++;
          updateUI();

          setTimeout(() => {
            startPoliceMode();
          }, 2000);
        }
      }

      // ============ FAZA 5 - POLICJA SIĘ DOMYŚLIŁA (poziom 7+) ============

      const policeEmojis = [
        "🚔",
        "🚨",
        "👮",
        "🚓",
        "🔫",
        "⚠️",
        "🚒",
        "🛑",
        "📢",
        "🔒",
      ];
      const wrongEmojis = [
        "🍕",
        "🎮",
        "🌟",
        "🎵",
        "🌈",
        "🐱",
        "🎂",
        "💎",
        "🌺",
        "🦄",
        "🍦",
        "🎪",
      ];

      function startPhase5() {
        gameState.phase = "phase5_commands";
        gameState.phase5CommandsRound = 0;
        gameState.phase5CommandsNeeded = 3 + Math.floor(Math.random() * 3); // 3-5 komend
        gameState.phase5EmojisNeeded = 5; // 5 emotikon do kliknięcia
        gameState.phase5EmojisClicked = 0;
        gameState.currentCodeRound = 0;
        gameState.codeRoundsNeeded = gameState.phase5CommandsNeeded;

        // Komendy do wpisania
        const phase5Commands = [
          "lock(door)",
          "secure(home)",
          "close(window)",
          "arm(alarm)",
          "hide(evidence)",
          "delete(logs)",
          "encrypt(files)",
        ];
        gameState.wordsToFind = phase5Commands.slice(
          0,
          gameState.phase5CommandsNeeded
        );

        stopTimer();

        // START EFEKTÓW POLICJI!
        startPoliceLights();
        startPoliceSiren();

        // Start timer 3.5 minuty
        startPoliceTimer();

        clearTerminal();
        addTerminalLine(
          '<span style="color: #ff0000;">🚨🚨🚨 POLICJA SIĘ DOMYŚLIŁA! 🚨🚨🚨</span>'
        );
        addTerminalLine("");
        addTerminalLine(
          '<span style="color: #ffff00;">Zhakowanie trudnego celu wzbudziło podejrzenia!</span>'
        );
        addTerminalLine("Musisz zabezpieczyć dom i ukryć się!");
        addTerminalLine("");
        addTerminalLine(
          `Krok 1: Zamknij dom (${gameState.phase5CommandsNeeded} komendy)`
        );
        addTerminalLine("Krok 2: Znajdź emotikony policyjne");

        document.getElementById("phaseIndicator").textContent =
          "🚨 FAZA 5: ZAMKNIJ DOM!";

        setTimeout(() => {
          showPhase5Commands();
        }, 2000);
      }

      function showPhase5Commands() {
        gameState.phase = "phase5_commands";
        gameState.userInput = [];

        gameState.currentCode =
          gameState.wordsToFind[gameState.currentCodeRound];

        document.getElementById(
          "phaseIndicator"
        ).textContent = `🚨 ZAMKNIJ DOM (${gameState.currentCodeRound + 1}/${
          gameState.codeRoundsNeeded
        })`;

        clearTerminal();
        addTerminalLine(
          '<span style="color: #ff0000;">🚨 ZABEZPIECZ DOM!</span>'
        );
        addTerminalLine("");
        addTerminalLine("function secureHouse() {");
        gameState.wordsToFind.forEach((cmd, i) => {
          if (i <= gameState.currentCodeRound) {
            addTerminalLine(`    ${cmd};`);
          }
        });
        addTerminalLine("}");
        addTerminalLine("");
        addTerminalLine(
          '<span class="command-prompt">root@home:~$</span> <span style="color: #ffff00;">' +
            gameState.currentCode +
            "</span>"
        );

        document.getElementById("inputArea").style.display = "block";
        document.getElementById("inputDisplay").textContent = "";
        document.getElementById("forgotBtnContainer").style.display = "none";

        createCodeKeyboard();
      }

      function showPhase5Emojis() {
        gameState.phase = "phase5_emojis";
        gameState.phase5EmojisClicked = 0;

        document.getElementById(
          "phaseIndicator"
        ).textContent = `🚨 ZNAJDŹ EMOTIKONY POLICYJNE (0/${gameState.phase5EmojisNeeded})`;

        clearTerminal();
        addTerminalLine(
          '<span style="color: #ff0000;">🚨 OSTATNI KROK!</span>'
        );
        addTerminalLine("");
        addTerminalLine("Kliknij wszystkie emotikony związane z policją!");
        addTerminalLine("Uważaj - kliknięcie złej emotikony = strata czasu!");
        addTerminalLine("");
        addTerminalLine(
          `Znajdź ${gameState.phase5EmojisNeeded} emotikon policyjnych.`
        );

        document.getElementById("inputArea").style.display = "none";

        // Stwórz siatkę emotikon
        createEmojiGrid();
      }

      function createEmojiGrid() {
        const keysDisplay = document.getElementById("keysDisplay");
        keysDisplay.innerHTML = "";
        keysDisplay.style.display = "grid";
        keysDisplay.style.gridTemplateColumns = "repeat(5, 1fr)";
        keysDisplay.style.gap = "10px";
        keysDisplay.style.maxWidth = "400px";
        keysDisplay.style.margin = "20px auto";

        // Wybierz 5 policyjnych i 10 złych emotikon
        const policeToUse = [...policeEmojis]
          .sort(() => Math.random() - 0.5)
          .slice(0, gameState.phase5EmojisNeeded);
        const wrongToUse = [...wrongEmojis]
          .sort(() => Math.random() - 0.5)
          .slice(0, 10);

        // Połącz i pomieszaj
        const allEmojis = [...policeToUse, ...wrongToUse].sort(
          () => Math.random() - 0.5
        );

        gameState.correctEmojis = policeToUse;
        gameState.clickedEmojis = [];

        allEmojis.forEach((emoji) => {
          const btn = document.createElement("button");
          btn.className = "key-button emoji-btn";
          btn.textContent = emoji;
          btn.style.fontSize = "30px";
          btn.style.padding = "15px";
          btn.style.cursor = "pointer";
          btn.onclick = () => clickEmoji(emoji, btn);
          keysDisplay.appendChild(btn);
        });
      }

      function clickEmoji(emoji, btn) {
        if (gameState.clickedEmojis.includes(emoji)) return; // Już kliknięte

        gameState.clickedEmojis.push(emoji);

        if (gameState.correctEmojis.includes(emoji)) {
          // Poprawna emotikona!
          gameState.phase5EmojisClicked++;
          btn.style.background =
            "linear-gradient(135deg, #00ff00 0%, #00aa00 100%)";
          btn.style.pointerEvents = "none";
          showMessage("✓ POPRAWNA!", "success");

          document.getElementById(
            "phaseIndicator"
          ).textContent = `🚨 ZNAJDŹ EMOTIKONY POLICYJNE (${gameState.phase5EmojisClicked}/${gameState.phase5EmojisNeeded})`;

          if (gameState.phase5EmojisClicked >= gameState.phase5EmojisNeeded) {
            // Wszystkie znalezione!
            setTimeout(() => {
              phase5Complete();
            }, 1000);
          }
        } else {
          // Zła emotikona!
          btn.style.background =
            "linear-gradient(135deg, #ff0000 0%, #aa0000 100%)";
          btn.style.pointerEvents = "none";
          showMessage("✗ ZŁA EMOTIKONA!", "error");
        }
      }

      function phase5Complete() {
        stopTimer();
        stopPoliceLights();
        stopPoliceSiren();

        showMessage("✓ UKRYŁEŚ SIĘ PRZED POLICJĄ!", "success");

        clearTerminal();
        addTerminalLine(
          '<span style="color: #00ff00;">✓ POLICJA ODJECHAŁA!</span>'
        );
        addTerminalLine("");
        addTerminalLine("Udało Ci się zabezpieczyć dom i ukryć!");
        addTerminalLine("Misja zakończona sukcesem!");

        document.getElementById("keysDisplay").style.display = "none";

        setTimeout(() => {
          missionComplete();
        }, 3000);
      }

      function checkPhase5Input() {
        const userCode = gameState.userInput.join("");

        if (userCode === gameState.currentCode) {
          gameState.currentCodeRound++;

          if (gameState.currentCodeRound < gameState.codeRoundsNeeded) {
            showMessage("✓ ZAMKNIĘTE!", "success");
            setTimeout(() => {
              showPhase5Commands();
            }, 1000);
          } else {
            // Wszystkie komendy - przejdź do emotikon
            showMessage("✓ DOM ZABEZPIECZONY!", "success");
            setTimeout(() => {
              showPhase5Emojis();
            }, 1500);
          }
        } else {
          showMessage("✗ BŁĄD!", "error");
          gameState.userInput = [];
          updateInputDisplay();
        }
      }

      // ============ TRYB POLICJI ============

      // Dźwięk syreny policyjnej (Web Audio API)
      let policeAudioContext = null;
      let policeSiren = null;

      function startPoliceSiren() {
        try {
          policeAudioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          policeSiren = policeAudioContext.createOscillator();
          const gainNode = policeAudioContext.createGain();

          policeSiren.connect(gainNode);
          gainNode.connect(policeAudioContext.destination);

          policeSiren.type = "sawtooth";
          gainNode.gain.value = 0.1;

          // Modulacja syreny
          policeSiren.frequency.setValueAtTime(
            600,
            policeAudioContext.currentTime
          );

          const modulateSiren = () => {
            if (!policeSiren) return;
            const now = policeAudioContext.currentTime;
            policeSiren.frequency.setValueAtTime(600, now);
            policeSiren.frequency.linearRampToValueAtTime(800, now + 0.5);
            policeSiren.frequency.linearRampToValueAtTime(600, now + 1);
            setTimeout(modulateSiren, 1000);
          };

          policeSiren.start();
          modulateSiren();
        } catch (e) {
          console.log("Audio not supported");
        }
      }

      function stopPoliceSiren() {
        try {
          if (policeSiren) {
            policeSiren.stop();
            policeSiren = null;
          }
          if (policeAudioContext) {
            policeAudioContext.close();
            policeAudioContext = null;
          }
        } catch (e) {}
      }

      function startPoliceLights() {
        // Usuń stary overlay jeśli istnieje
        const oldOverlay = document.getElementById("policeOverlay");
        if (oldOverlay) oldOverlay.remove();

        const overlay = document.createElement("div");
        overlay.id = "policeOverlay";
        overlay.className = "police-overlay";
        document.body.appendChild(overlay);
      }

      function stopPoliceLights() {
        const overlay = document.getElementById("policeOverlay");
        if (overlay) overlay.remove();
      }

      function startPoliceMode() {
        // ZAPISZ STAN PRZED POLICJĄ (do przywrócenia po ucieczce)
        gameState.savedState = {
          phase: gameState.phase,
          keysToRemember: [...gameState.keysToRemember],
          currentMemoryRound: gameState.currentMemoryRound,
          memoryRoundsNeeded: gameState.memoryRoundsNeeded,
          currentCodeRound: gameState.currentCodeRound,
          codeRoundsNeeded: gameState.codeRoundsNeeded,
          wordsToFind: [...gameState.wordsToFind],
          currentCode: gameState.currentCode,
          currentFinalRound: gameState.currentFinalRound,
          finalRoundsNeeded: gameState.finalRoundsNeeded,
          finalCode: gameState.finalCode,
          finalCodes: [...gameState.finalCodes],
          finalJSCode: gameState.finalJSCode,
          timeLimit: gameState.timeLimit,
        };

        gameState.policeMode = true;
        gameState.phase = "police_memorize";
        gameState.homePassword = generateHomePassword();
        gameState.currentMemoryRound = 0;
        gameState.currentCodeRound = 0;

        // Automatycznie 6 znaków w trybie policji
        gameState.keysToRemember = generateKeys(6);
        gameState.memoryRoundsNeeded = 1;

        // Więcej komend do wpisania w trybie policji (zabezpieczanie domu)
        const policeCommands = [
          "lock(door)",
          "secure(home)",
          "close(window)",
          "arm(alarm)",
          "hide(evidence)",
        ];

        // Losowa liczba komend (3-5)
        const numCommands = 3 + Math.floor(Math.random() * 3);
        gameState.codeRoundsNeeded = numCommands;
        gameState.wordsToFind = policeCommands.slice(0, numCommands);

        stopTimer();

        // START EFEKTÓW POLICJI!
        startPoliceLights();
        startPoliceSiren();

        clearTerminal();
        addTerminalLine(
          '<span style="color: #ff0000;">🚨🚨🚨 ALARM! POLICJA W DRODZE! 🚨🚨🚨</span>'
        );
        addTerminalLine("");
        addTerminalLine(
          '<span style="color: #ff0000;">MUSISZ ZABEZPIECZYĆ DOM!</span>'
        );
        addTerminalLine(`Masz 3.5 MINUTY na zamknięcie ${numCommands} rzeczy!`);
        addTerminalLine("");
        addTerminalLine("Zapamiętaj sekwencję klawiszy:");

        document.getElementById("phaseIndicator").textContent =
          "🚨 POLICJA! ZAMKNIJ DRZWI!";

        // Start 3.5-minutowy timer
        startPoliceTimer();

        showPoliceMemorizePhase();
      }

      function startPoliceTimer() {
        // Zatrzymaj poprzedni timer jeśli działa
        stopTimer();

        let timeLeft = 120; // 2 minuty
        const timerDisplay = document.getElementById("timerDisplay");
        timerDisplay.style.display = "block";
        timerDisplay.style.color = "#ff0000";
        timerDisplay.style.borderColor = "#ff0000";
        timerDisplay.textContent = `🚨 ${timeLeft}s`;

        gameState.timerInterval = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = `🚨 ${timeLeft}s`;

          if (timeLeft <= 0) {
            stopTimer();
            policeCaught();
          }
        }, 1000);
      }

      function showPoliceMemorizePhase() {
        gameState.phase = "police_memorize";

        document.getElementById(
          "phaseIndicator"
        ).textContent = `🚨 ZAPAMIĘTAJ KOD DRZWI (${
          gameState.currentMemoryRound + 1
        }/${gameState.memoryRoundsNeeded})`;

        const keysDisplay = document.getElementById("keysDisplay");
        keysDisplay.innerHTML = "";
        keysDisplay.style.display = "flex";

        gameState.keysToRemember.forEach((key, index) => {
          setTimeout(() => {
            const keyElement = document.createElement("div");
            keyElement.className = "key";
            keyElement.style.background =
              "linear-gradient(135deg, #ff0000 0%, #cc0000 100%)";
            keyElement.textContent = key;
            keysDisplay.appendChild(keyElement);
          }, index * 150);
        });

        document.getElementById("inputArea").style.display = "none";
        document.getElementById("readyButton").style.display = "none";

        setTimeout(() => {
          document.getElementById("readyButton").style.display = "block";
        }, gameState.keysToRemember.length * 150 + 500);
      }

      function showPoliceInputPhase() {
        gameState.phase = "police_input";
        gameState.userInput = [];

        document.getElementById("phaseIndicator").textContent =
          "🚨 WPISZ KOD DRZWI!";
        document.getElementById("keysDisplay").style.display = "none";
        document.getElementById("inputArea").style.display = "block";
        document.getElementById("inputDisplay").textContent = "";

        // Pokaż przycisk "Nie pamiętam" (w trybie policji = od razu łapią)
        document.getElementById("forgotBtnContainer").style.display = "block";

        createKeyboard();
      }

      function showPoliceCodePhase() {
        gameState.phase = "police_code";
        gameState.userInput = [];
        gameState.currentCode =
          gameState.wordsToFind[gameState.currentCodeRound];

        document.getElementById(
          "phaseIndicator"
        ).textContent = `🚨 ZAMKNIJ DRZWI (${gameState.currentCodeRound + 1}/${
          gameState.codeRoundsNeeded
        })`;

        clearTerminal();
        addTerminalLine(
          '<span style="color: #ff0000;">🚨 ZAMYKANIE DRZWI...</span>'
        );
        addTerminalLine("");
        addTerminalLine(`function secureDoor() {`);
        addTerminalLine(`    lock(door);`);
        addTerminalLine(`    secure(home);`);
        addTerminalLine(`    password: "${gameState.homePassword}"`);
        addTerminalLine(`}`);
        addTerminalLine("");
        addTerminalLine(
          '<span class="command-prompt">root@home:~$</span> <span style="color: #ffff00;">' +
            gameState.currentCode +
            "</span>"
        );

        document.getElementById("inputArea").style.display = "block";
        document.getElementById("inputDisplay").textContent = "";

        createCodeKeyboard();
      }

      function showPoliceFinalPhase() {
        gameState.phase = "police_final";
        gameState.userInput = [];

        document.getElementById("phaseIndicator").textContent =
          "🚨 WPISZ HASŁO ZABEZPIECZAJĄCE!";

        clearTerminal();
        addTerminalLine(
          '<span style="color: #ff0000;">🚨 OSTATNI KROK - HASŁO DOMU!</span>'
        );
        addTerminalLine("");
        addTerminalLine(`function secureDoor() {`);
        addTerminalLine(`    lock(door);`);
        addTerminalLine(`    secure(home);`);
        addTerminalLine(`    password: "${gameState.homePassword}"`);
        addTerminalLine(`}`);
        addTerminalLine("");
        addTerminalLine("Wpisz hasło zabezpieczające (8 znaków):");

        document.getElementById("inputArea").style.display = "block";
        document.getElementById("inputDisplay").textContent = "";

        createPoliceKeyboard();
      }

      function createPoliceKeyboard() {
        const keyboard = document.getElementById("keyboard");
        keyboard.innerHTML = "";
        keyboard.style.display = "grid";
        keyboard.style.gridTemplateColumns =
          "repeat(auto-fit, minmax(40px, 1fr))";

        const keys = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");

        keys.forEach((key) => {
          const button = document.createElement("button");
          button.className = "key-button";
          button.textContent = key;
          button.style.background =
            "linear-gradient(135deg, #330000 0%, #660000 100%)";
          button.onclick = () => addKey(key);
          keyboard.appendChild(button);
        });
      }

      function checkPoliceInput() {
        if (gameState.phase === "police_input") {
          const correct =
            gameState.userInput.join("") === gameState.keysToRemember.join("");
          if (correct) {
            gameState.currentMemoryRound++;
            showMessage("✓ KOD POPRAWNY!", "success");
            setTimeout(() => {
              showPoliceCodePhase();
            }, 1000);
          } else {
            showMessage("✗ BŁĘDNY KOD!", "error");
            gameState.userInput = [];
            updateInputDisplay();
          }
        } else if (gameState.phase === "police_code") {
          const userCode = gameState.userInput.join("");
          if (userCode === gameState.currentCode) {
            gameState.currentCodeRound++;
            if (gameState.currentCodeRound < gameState.codeRoundsNeeded) {
              showMessage("✓ DRZWI ZAMKNIĘTE!", "success");
              setTimeout(() => {
                showPoliceCodePhase();
              }, 1000);
            } else {
              showMessage("✓ WSZYSTKIE DRZWI ZAMKNIĘTE!", "success");
              setTimeout(() => {
                showPoliceFinalPhase();
              }, 1000);
            }
          } else {
            showMessage("✗ BŁĄD!", "error");
            gameState.userInput = [];
            updateInputDisplay();
          }
        } else if (gameState.phase === "police_final") {
          const userCode = gameState.userInput.join("");
          if (userCode === gameState.homePassword) {
            policeEscaped();
          } else {
            showMessage("✗ BŁĘDNE HASŁO!", "error");
            gameState.userInput = [];
            updateInputDisplay();
          }
        }
      }

      function policeCaught() {
        stopTimer();
        stopPoliceLights();
        stopPoliceSiren();
        gameState.policeMode = false;

        // Tracisz 5 ukończonych misji + cofasz aktualną misję o 5
        const missionsLost = 5;
        gameState.stats.completed = Math.max(
          0,
          gameState.stats.completed - missionsLost
        );
        gameState.currentMission = Math.max(
          1,
          gameState.currentMission - missionsLost
        );

        showMessage(`🚔 POLICJA CIĘ ZŁAPAŁA! -${missionsLost} MISJI!`, "error");

        clearTerminal();
        addTerminalLine(
          '<span style="color: #ff0000;">🚔🚔🚔 ZŁAPANY! 🚔🚔🚔</span>'
        );
        addTerminalLine("");
        addTerminalLine("Policja złapała Cię!");
        addTerminalLine(
          `<span style="color: #ff0000;">Tracisz ${missionsLost} misji!</span>`
        );
        addTerminalLine("");
        addTerminalLine(`Cofasz się do misji: ${gameState.currentMission}`);
        addTerminalLine(`Ukończone: ${gameState.stats.completed}`);

        // Ukryj przycisk "nie pamiętam"
        document.getElementById("forgotBtnContainer").style.display = "none";

        saveGame();
        updateUI();

        setTimeout(() => {
          startMission();
        }, 4000);
      }

      function policeEscaped() {
        stopTimer();
        stopPoliceLights();
        stopPoliceSiren();
        gameState.policeMode = false;

        showMessage("✓ UCIEKŁEŚ POLICJI!", "success");

        clearTerminal();
        addTerminalLine(
          '<span style="color: #00ff00;">✓ DOM ZABEZPIECZONY!</span>'
        );
        addTerminalLine("");
        addTerminalLine("Udało Ci się zamknąć wszystkie drzwi!");
        addTerminalLine("Policja odjechała.");
        addTerminalLine("");
        addTerminalLine("Wracasz do hakowania...");

        // Ukryj przycisk "nie pamiętam"
        document.getElementById("forgotBtnContainer").style.display = "none";

        // PRZYWRÓĆ STAN SPRZED POLICJI
        if (gameState.savedState) {
          setTimeout(() => {
            // Przywróć zapisany stan
            gameState.phase = gameState.savedState.phase;
            gameState.keysToRemember = gameState.savedState.keysToRemember;
            gameState.currentMemoryRound =
              gameState.savedState.currentMemoryRound;
            gameState.memoryRoundsNeeded =
              gameState.savedState.memoryRoundsNeeded;
            gameState.currentCodeRound = gameState.savedState.currentCodeRound;
            gameState.codeRoundsNeeded = gameState.savedState.codeRoundsNeeded;
            gameState.wordsToFind = gameState.savedState.wordsToFind;
            gameState.currentCode = gameState.savedState.currentCode;
            gameState.currentFinalRound =
              gameState.savedState.currentFinalRound;
            gameState.finalRoundsNeeded =
              gameState.savedState.finalRoundsNeeded;
            gameState.finalCode = gameState.savedState.finalCode;
            gameState.finalCodes = gameState.savedState.finalCodes;
            gameState.finalJSCode = gameState.savedState.finalJSCode;
            gameState.timeLimit = gameState.savedState.timeLimit;
            gameState.userInput = [];
            gameState.savedState = null;

            // URUCHOM TIMER PO POWROCIE!
            startTimer();

            // Wróć do odpowiedniej fazy
            if (gameState.phase === "memorize") {
              showMemorizePhase();
            } else if (gameState.phase === "input") {
              showMemorizePhase(); // Pokaż klawisze od nowa
            } else if (gameState.phase === "code") {
              showCodePhase();
            } else if (
              gameState.phase === "final" ||
              gameState.phase === "catch_game"
            ) {
              showFinalPhase();
            }
          }, 3000);
        } else {
          setTimeout(() => {
            startMission();
          }, 3000);
        }
      }

      function missionComplete() {
        stopTimer();

        const timeSpent = Math.floor((Date.now() - gameState.startTime) / 1000);

        addTerminalLine("");
        addTerminalLine("═══════════════════════════════════════════");
        addTerminalLine("🎉 DOSTĘP UZYSKANY! 🎉");
        addTerminalLine(`Czas: ${timeSpent}s`);
        addTerminalLine("═══════════════════════════════════════════");

        showMessage("🎉 CEL ZHAKOWANY!", "success");

        gameState.stats.completed++;
        gameState.stats.totalAttempts += gameState.attempts;
        gameState.stats.totalTime += timeSpent;
        gameState.attempts = 0;

        if (gameState.currentMission % 50 === 0) {
          gameState.stats.rewards++;
          setTimeout(() => {
            showMessage(
              `🏆 NAGRODA ZA ${gameState.currentMission} MISJI!`,
              "success"
            );
          }, 2000);
        }

        gameState.currentMission++;

        if (gameState.currentMission > TOTAL_MISSIONS) {
          setTimeout(() => {
            showMessage(
              "🏆 GRATULACJE! UKOŃCZYŁEŚ WSZYSTKIE 100 MISJI!",
              "success"
            );
          }, 3000);
        } else {
          saveGame();
          updateUI();

          setTimeout(() => {
            startMission();
          }, 3000);
        }
      }

      function startTimer() {
        // Używaj zapisanego timeLimit, nie generuj nowej misji!
        if (gameState.timeLimit === 0) {
          document.getElementById("timerDisplay").style.display = "none";
          return;
        }

        // Nie startuj nowego timera jeśli już działa
        if (gameState.timerInterval) return;

        const timerDisplay = document.getElementById("timerDisplay");
        timerDisplay.style.display = "block";
        timerDisplay.style.color = "#00ff00";
        timerDisplay.style.borderColor = "#00ff00";

        let timeLeft = gameState.timeLimit;
        timerDisplay.textContent = `⏱️ ${timeLeft}s`;

        gameState.timerInterval = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = `⏱️ ${timeLeft}s`;

          if (timeLeft <= 30) {
            timerDisplay.style.color = "#ffff00";
            timerDisplay.style.borderColor = "#ffff00";
          }

          if (timeLeft <= 10) {
            timerDisplay.style.color = "#ff0000";
            timerDisplay.style.borderColor = "#ff0000";
          }

          if (timeLeft <= 0) {
            stopTimer();
            missionFailed();
          }
        }, 1000);
      }

      function stopTimer() {
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
          gameState.timerInterval = null;
        }
      }

      function missionFailed() {
        showMessage("⏰ CZAS MINĄŁ! MISJA NIEUDANA!", "error");
        gameState.attempts++;

        setTimeout(() => {
          startMission();
        }, 2000);
      }

      function showMessage(text, type = "success") {
        const existing = document.querySelector(".message");
        if (existing) existing.remove();

        const message = document.createElement("div");
        message.className = `message ${type}`;
        message.textContent = text;
        document.body.appendChild(message);

        setTimeout(() => {
          message.remove();
        }, 2000);
      }

      function updateUI() {
        document.getElementById(
          "currentMission"
        ).textContent = `${gameState.currentMission}/${TOTAL_MISSIONS}`;
        document.getElementById("progressPercent").textContent = `${Math.floor(
          ((gameState.currentMission - 1) / TOTAL_MISSIONS) * 100
        )}%`;
        document.getElementById("attempts").textContent = gameState.attempts;

        const totalMinutes = Math.floor(gameState.stats.totalTime / 60);
        const totalSeconds = gameState.stats.totalTime % 60;
        document.getElementById(
          "totalTime"
        ).textContent = `${totalMinutes}:${totalSeconds
          .toString()
          .padStart(2, "0")}`;

        document.getElementById("completed").textContent =
          gameState.stats.completed;

        const successRate =
          gameState.stats.totalAttempts > 0
            ? Math.floor(
                (gameState.stats.completed / gameState.stats.totalAttempts) *
                  100
              )
            : 0;
        document.getElementById("successRate").textContent = `${successRate}%`;

        const avgTime =
          gameState.stats.completed > 0
            ? Math.floor(gameState.stats.totalTime / gameState.stats.completed)
            : 0;
        document.getElementById("avgTime").textContent = `${avgTime}s`;

        document.getElementById(
          "rewards"
        ).textContent = `${gameState.stats.rewards} 🏆`;

        const progress =
          ((gameState.currentMission - 1) / TOTAL_MISSIONS) * 100;
        document.getElementById("progressFill").style.width = `${progress}%`;
      }

      document.addEventListener("keydown", (e) => {
        // SPACJA dla mini-gry łapania emotikonek
        if (e.key === " " && gameState.phase === "catch_game") {
          e.preventDefault();
          catchAttempt();
          return;
        }

        // Blokada spamu Enter
        if (e.key === "Enter" && gameState.isProcessing) {
          e.preventDefault();
          return;
        }

        const validPhases = [
          "input",
          "code",
          "final",
          "police_input",
          "police_code",
          "police_final",
          "phase5_commands",
        ];
        if (!validPhases.includes(gameState.phase)) return;

        // W fazie code używamy małych liter
        let key;
        if (
          gameState.phase === "code" ||
          gameState.phase === "police_code" ||
          gameState.phase === "phase5_commands"
        ) {
          key = e.key.toLowerCase();
        } else {
          key = e.key.toUpperCase();
        }

        if (/^[a-zA-Z0-9]$/.test(key)) {
          addKey(key);
        } else if (e.key === " ") {
          addKey(" ");
        } else if (e.key === "Backspace") {
          e.preventDefault();
          gameState.userInput.pop();
          updateInputDisplay();
        } else if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("submitBtn").click();
        } else if (
          gameState.phase === "code" ||
          gameState.phase === "police_code" ||
          gameState.phase === "phase5_commands"
        ) {
          const specialChars = ".,:;-_()[]{}/<>|&%!?@#$*+='\"\\";
          if (specialChars.includes(e.key)) {
            addKey(e.key);
          }
        }
      });

      // Sprawdź czy to pierwsza wizyta
      function checkFirstVisit() {
        const hasSeenWarning = localStorage.getItem("hackerSimWarning");
        const savedQuality = localStorage.getItem("hackerSimQuality");

        // Jeśli gracz nie wybierał jakości - ustaw domyślną dla urządzenia
        if (!savedQuality) {
          const defaultQuality = getDefaultQuality();
          setQuality(defaultQuality, false); // false = nie zapisuj, bo to domyślna
        } else {
          setQuality(savedQuality, false);
        }

        if (!hasSeenWarning) {
          document.getElementById("warningOverlay").style.display = "flex";
        } else {
          document.getElementById("warningOverlay").style.display = "none";
          startGame();
        }
      }

      // Wykryj urządzenie i zwróć domyślną jakość
      function getDefaultQuality() {
        const isMobile =
          /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
            navigator.userAgent
          );
        const isLowEndDevice =
          navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;
        const isSmallScreen = window.innerWidth < 768;
        const hasLowMemory =
          navigator.deviceMemory && navigator.deviceMemory < 4;

        // Telefon lub słabe urządzenie = NISKA
        if (isMobile || hasLowMemory) {
          return "low";
        }

        // Tablet lub średnie urządzenie = ŚREDNIA
        if (isSmallScreen || isLowEndDevice) {
          return "medium";
        }

        // Komputer = WYSOKA
        return "high";
      }

      function setQuality(quality, save = true) {
        document.body.className = `quality-${quality}`;

        // Zapisz tylko jeśli gracz sam wybrał
        if (save) {
          localStorage.setItem("hackerSimQuality", quality);
        }

        // Aktualizuj aktywny przycisk (wszystkie selektory)
        document.querySelectorAll(".quality-btn").forEach((btn) => {
          btn.classList.remove("active");
          if (btn.dataset.quality === quality) {
            btn.classList.add("active");
          }
        });
      }

      // Obsługa przycisków jakości (warning overlay)
      document.querySelectorAll(".quality-btn").forEach((btn) => {
        btn.onclick = () => {
          setQuality(btn.dataset.quality, true); // true = zapisz wybór gracza
        };
      });

      // Obsługa modala ustawień
      document.getElementById("openSettingsBtn").onclick = () => {
        document.getElementById("settingsModal").style.display = "flex";
      };

      document.getElementById("closeSettingsBtn").onclick = () => {
        document.getElementById("settingsModal").style.display = "none";
      };

      // Zamknij modal klikając poza nim
      document.getElementById("settingsModal").onclick = (e) => {
        if (e.target.id === "settingsModal") {
          document.getElementById("settingsModal").style.display = "none";
        }
      };

      function startGame() {
        loadGame();
        setTimeout(() => {
          startMission();
        }, 1000);
      }

      // Przycisk start w ostrzeżeniu
      document.getElementById("startGameBtn").onclick = () => {
        localStorage.setItem("hackerSimWarning", "true");
        document.getElementById("warningOverlay").style.display = "none";
        startGame();
      };

      window.onload = () => {
        checkFirstVisit();
      };
    </script>
  </body>
</html>
